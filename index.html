<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Blue vs Red Squares</title>
  <style>
    body { margin: 0; background: #111; }
    canvas { display: block; margin: 0 auto; }
  </style>

  <!-- Phaser 3 from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.85.0/dist/phaser.js"></script>
</head>
<body>

<script>
// ===== Phaser config =====
const config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    backgroundColor: "#222222",
    physics: {
        default: "arcade",
        arcade: {
            debug: false
        }
    },
    scene: {
        preload,
        create,
        update
    }
};

const game = new Phaser.Game(config);

let player;
let cursors;
let bullets;
let enemies;
let lastFired = 0;

let level = 1;
let killsThisLevel = 0;
let killsToNextLevel = 5; // kills needed to level up

let levelText;
let infoText;

function preload () {
    // no external images: using generated textures
}

function create () {
    // ----- Create simple textures -----
    const graphics = this.add.graphics();

    // player = blue square 32x32
    graphics.fillStyle(0x0000ff, 1);
    graphics.fillRect(0, 0, 32, 32);
    graphics.generateTexture("playerBlue", 32, 32);
    graphics.clear();

    // enemy = red square 28x28
    graphics.fillStyle(0xff0000, 1);
    graphics.fillRect(0, 0, 28, 28);
    graphics.generateTexture("enemyRed", 28, 28);
    graphics.destroy();

    // ----- Player -----
    player = this.physics.add.sprite(400, 300, "playerBlue");
    player.setCollideWorldBounds(true);
    player.speed = 200;

    // ----- Bullets group -----
    bullets = this.physics.add.group({
        classType: Phaser.Physics.Arcade.Image,
        maxSize: 50,
        runChildUpdate: true
    });

    // ----- Enemies group -----
    enemies = this.physics.add.group();

    // ----- Controls -----
    cursors = this.input.keyboard.createCursorKeys();
    this.input.mouse.capture();

    // ----- UI text -----
    levelText = this.add.text(10, 10, "Level: 1", { font: "20px Arial", fill: "#ffffff" });
    infoText = this.add.text(10, 35, "Move: Arrows | Shoot: Mouse", { font: "16px Arial", fill: "#ffffff" });

    // ----- Collisions: bullets vs enemies -----
    this.physics.add.overlap(bullets, enemies, (bullet, enemy) => {
        bullet.destroy();
        enemy.health -= 1;
        if (enemy.health <= 0) {
            enemy.destroy();
            killsThisLevel++;
            if (killsThisLevel >= killsToNextLevel) {
                levelUp.call(this);
            }
        }
    });

    // ----- Collisions: player vs enemies -----
    this.physics.add.overlap(player, enemies, () => {
        // Simple: restart scene and reset progress
        this.scene.restart();
        level = 1;
        killsThisLevel = 0;
        killsToNextLevel = 5;
    });

    // initial enemies
    spawnWave.call(this);
}

function update (time, delta) {
    handlePlayerMovement();
    handleShooting(this, time);

    // enemies chase player
    enemies.children.iterate(enemy => {
        if (!enemy || !enemy.active) return;
        this.physics.moveToObject(enemy, player, enemy.speed);
    });
}

function handlePlayerMovement() {
    player.setVelocity(0);

    if (cursors.left.isDown) {
        player.setVelocityX(-player.speed);
    } else if (cursors.right.isDown) {
        player.setVelocityX(player.speed);
    }

    if (cursors.up.isDown) {
        player.setVelocityY(-player.speed);
    } else if (cursors.down.isDown) {
        player.setVelocityY(player.speed);
    }
}

function handleShooting(scene, time) {
    const pointer = scene.input.activePointer;

    // left mouse button held
    if (pointer.isDown && time > lastFired + 200) {
        lastFired = time;

        const bullet = bullets.get(player.x, player.y, null);
        if (bullet) {
            bullet.setCircle(4);
            bullet.setTint(0xffffff);
            bullet.setActive(true);
            bullet.setVisible(true);

            scene.physics.world.enable(bullet);

            const angle = Phaser.Math.Angle.Between(
                player.x, player.y,
                pointer.worldX, pointer.worldY
            );
            const speed = 400;
            bullet.setVelocity(Math.cos(angle) * speed, Math.sin(angle) * speed);

            // destroy after 1s
            scene.time.delayedCall(1000, () => {
                if (bullet && bullet.active) bullet.destroy();
            });
        }
    }
}

function spawnWave() {
    enemies.clear(true, true);

    const enemyCount = 3 + level * 2;
    const baseSpeed = 60 + level * 15;
    const baseHealth = 1 + Math.floor(level / 2);

    for (let i = 0; i < enemyCount; i++) {
        const side = Phaser.Math.Between(0, 3); // 0 top, 1 right, 2 bottom, 3 left
        let x, y;
        if (side === 0) {
            x = Phaser.Math.Between(0, 800);
            y = -20;
        } else if (side === 1) {
            x = 820;
            y = Phaser.Math.Between(0, 600);
        } else if (side === 2) {
            x = Phaser.Math.Between(0, 800);
            y = 620;
        } else {
            x = -20;
            y = Phaser.Math.Between(0, 600);
        }

        const enemy = enemies.create(x, y, "enemyRed");
        enemy.speed = baseSpeed;
        enemy.health = baseHealth;
        enemy.setCollideWorldBounds(false);
    }
}

function levelUp() {
    level++;
    killsThisLevel = 0;
    killsToNextLevel += 3;
    levelText.setText("Level: " + level);

    // player gets stronger
    player.speed += 15;

    // harder wave
    spawnWave.call(this);
}
</script>

</body>
</html>

