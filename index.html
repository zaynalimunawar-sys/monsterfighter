<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Glass Sword Swarm</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <style>
    :root {
      --safe-area-top: env(safe-area-inset-top);
      --safe-area-right: env(safe-area-inset-right);
      --safe-area-bottom: env(safe-area-inset-bottom);
      --safe-area-left: env(safe-area-inset-left);
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1e293b, #020617);
      font-family: -apple-system, system-ui, sans-serif;
      overflow: hidden;
    }

    canvas {
      display: block;
      margin: 0 auto;
      touch-action: none;
    }

    /* Glassmorphic overlay container pinned to screen edges (safe area aware) [web:177][web:180] */
    .hud-layer {
      position: fixed;
      inset: var(--safe-area-top) var(--safe-area-right) var(--safe-area-bottom) var(--safe-area-left);
      pointer-events: none;
    }

    /* Glass panel for joystick and buttons [web:176][web:179][web:185] */
    .glass-panel {
      position: absolute;
      background: rgba(15, 23, 42, 0.35);
      border-radius: 22px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(22px) saturate(140%);
      -webkit-backdrop-filter: blur(22px) saturate(140%);
      pointer-events: auto;
    }

    /* Bottom-left panel for joystick */
    .panel-left {
      left: 14px;
      bottom: 14px;
      width: 150px;
      height: 150px;
    }

    /* Bottom-right panel for attack */
    .panel-right {
      right: 14px;
      bottom: 14px;
      width: 130px;
      height: 130px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Glass button inside panel */
    .glass-button {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.35);
      background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.1));
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(26px);
      -webkit-backdrop-filter: blur(26px);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(15, 23, 42, 0.9);
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
    }

    .glass-button:active {
      transform: translateY(2px) scale(0.97);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.7);
    }

    /* Joystick canvas placed inside glass panel */
    #joy-layer {
      position: absolute;
      left: 0;
      top: 0;
      width: 150px;
      height: 150px;
      pointer-events: none; /* actual touch handled by Phaser underneath */
    }

    /* On desktop, shrink panels a bit */
    @media (min-width: 900px) {
      .panel-left { width: 140px; height: 140px; }
      .panel-right { width: 120px; height: 120px; }
      .glass-button { width: 80px; height: 80px; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.85.0/dist/phaser.js"></script>
</head>
<body>

<div class="hud-layer">
  <div class="glass-panel panel-left">
    <canvas id="joy-layer"></canvas>
  </div>
  <div class="glass-panel panel-right">
    <div id="attack-btn" class="glass-button">SWING</div>
  </div>
</div>

<script>
// Responsive, iPhone-friendly scaling [web:171][web:174][web:180]
const config = {
  type: Phaser.AUTO,
  width: 800,
  height: 600,
  backgroundColor: "#020617",
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH
  },
  physics: {
    default: "arcade",
    arcade: { debug: false }
  },
  scene: { preload, create, update }
};

let game = new Phaser.Game(config);

let player, monsters, swordHitbox;
let score = 0, scoreText;
let cursors;

let joyPointer = null;
let joyRadius = 60;
let moveVector = { x: 0, y: 0 };

let attacking = false;
let canAttack = true;

function preload() {}

function create() {
  const g = this.add.graphics();

  // player / monster / sword textures
  g.fillStyle(0x38bdf8, 1);
  g.fillRoundedRect(0, 0, 30, 30, 8);
  g.generateTexture("playerBlue", 30, 30);
  g.clear();

  g.fillStyle(0xf97373, 1);
  g.fillRoundedRect(0, 0, 26, 26, 8);
  g.generateTexture("monsterRed", 26, 26);
  g.clear();

  g.fillStyle(0xfacc15, 0.7);
  g.fillRoundedRect(0, 0, 36, 16, 6);
  g.generateTexture("swordBox", 36, 16);
  g.destroy();

  // Player
  player = this.physics.add.sprite(400, 300, "playerBlue");
  player.setCollideWorldBounds(true);
  player.speed = 220;
  player.facing = "down";

  // Sword hitbox
  swordHitbox = this.physics.add.image(player.x, player.y, "swordBox");
  swordHitbox.setVisible(false);
  swordHitbox.body.enable = false;

  // Monster group
  monsters = this.physics.add.group();
  spawnMonsters.call(this, 6);

  // Keyboard
  cursors = this.input.keyboard.createCursorKeys();

  // Score
  scoreText = this.add.text(16, 16, "Score: 0", {
    font: "20px -apple-system, system-ui, sans-serif",
    fill: "#e5e7eb"
  });

  // Collisions
  this.physics.add.overlap(swordHitbox, monsters, (s, m) => {
    if (!attacking) return;
    m.destroy();
    score++;
    scoreText.setText("Score: " + score);
    if (monsters.countActive(true) === 0) {
      spawnMonsters.call(this, 6 + Math.floor(score / 3));
    }
  });

  this.physics.add.overlap(player, monsters, () => {
    score = 0;
    this.scene.restart();
  });

  // Virtual joystick touch handling (under glass panel) [web:145][web:148][web:152]
  const joyPanelRect = document.querySelector(".panel-left").getBoundingClientRect();
  const canvasOffsetX = joyPanelRect.left;
  const canvasOffsetY = joyPanelRect.top;

  this.input.on("pointerdown", (pointer) => {
    // Limit joystick to left-bottom quadrant
    if (pointer.x + canvasOffsetX < joyPanelRect.right &&
        pointer.x + canvasOffsetX > joyPanelRect.left &&
        pointer.y + canvasOffsetY < joyPanelRect.bottom &&
        pointer.y + canvasOffsetY > joyPanelRect.top) {
      joyPointer = pointer.id;
      updateJoy(pointer, joyPanelRect);
    }
  });

  this.input.on("pointermove", (pointer) => {
    if (joyPointer === pointer.id) {
      updateJoy(pointer, joyPanelRect);
    }
  });

  this.input.on("pointerup", (pointer) => {
    if (joyPointer === pointer.id) {
      joyPointer = null;
      moveVector.x = 0;
      moveVector.y = 0;
      drawJoyNeutral();
    }
  });

  // Attack: HTML button plus keyboard SPACE [web:145][web:150]
  const attackBtnEl = document.getElementById("attack-btn");
  attackBtnEl.addEventListener("touchstart", (e) => {
    e.preventDefault();
    tryAttack.call(this);
  }, { passive: false });
  attackBtnEl.addEventListener("mousedown", (e) => {
    e.preventDefault();
    tryAttack.call(this);
  });

  this.input.keyboard.on("keydown-SPACE", () => {
    tryAttack.call(this);
  });

  setupJoyCanvas();
}

function update(time, delta) {
  handleMovement();
  updateSwordHitbox();
  moveMonsters();
}

function handleMovement() {
  player.setVelocity(0);

  // Keyboard movement
  if (cursors.left && cursors.left.isDown) player.setVelocityX(-player.speed);
  if (cursors.right && cursors.right.isDown) player.setVelocityX(player.speed);
  if (cursors.up && cursors.up.isDown) player.setVelocityY(-player.speed);
  if (cursors.down && cursors.down.isDown) player.setVelocityY(player.speed);

  // Joystick movement overrides if active
  if (moveVector.x !== 0 || moveVector.y !== 0) {
    player.setVelocity(moveVector.x * player.speed, moveVector.y * player.speed);
  }

  if (player.body.velocity.lengthSq() > 0) {
    const vx = player.body.velocity.x;
    const vy = player.body.velocity.y;
    if (Math
