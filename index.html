<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>OPERATION: ASTEROID DEFENSE |  ULTIMATE EDITION</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,maximum-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    :root {
      --safe-area-top: env(safe-area-inset-top);
      --safe-area-bottom: env(safe-area-inset-bottom);
      --ubi-orange: #FF6600;
      --ubi-blue: #0099FF;
      --ubi-yellow: #FFD700;
      --ubi-red: #FF0033;
      --ubi-green: #00FF66;
      --orange-glow: rgba(255, 102, 0, 0.4);
      --blue-glow: rgba(0, 153, 255, 0.4);
      --green-glow: rgba(0, 255, 102, 0.4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    @keyframes starTwinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    @keyframes glitchText {
      0%, 100% { 
        transform: translate(0) skew(0deg);
        text-shadow: 
          0 0 40px var(--orange-glow),
          0 0 80px var(--orange-glow);
      }
      14% { 
        transform: translate(-3px, 3px) skew(-2deg);
        text-shadow: 
          3px 0 var(--ubi-orange), 
          -3px 0 var(--ubi-blue),
          0 0 40px var(--orange-glow);
      }
      15% { 
        transform: translate(3px, -3px) skew(2deg);
        text-shadow: 
          -3px 0 var(--ubi-orange), 
          3px 0 var(--ubi-blue);
      }
      16% { 
        transform: translate(0) skew(0deg);
      }
    }

    @keyframes scanLine {
      0% { transform: translateY(-100%); opacity: 0.3; }
      50% { opacity: 0.6; }
      100% { transform: translateY(100vh); opacity: 0.3; }
    }

    @keyframes fadeInScale {
      0% { 
        opacity: 0;
        transform: scale(0.9);
      }
      100% { 
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes meteorShower {
      0% {
        transform: translateX(-100px) translateY(-100px);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateX(300px) translateY(300px);
        opacity: 0;
      }
    }

    @keyframes buttonGlow {
      0%, 100% {
        box-shadow: 
          0 0 20px var(--orange-glow),
          0 8px 24px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }
      50% {
        box-shadow: 
          0 0 40px var(--orange-glow),
          0 0 60px var(--orange-glow),
          0 12px 32px rgba(0, 0, 0, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.5);
      }
    }

    @keyframes floatText {
      0%, 100% {
        transform: translateY(0px);
        text-shadow: 
          0 0 30px var(--orange-glow),
          0 0 60px var(--orange-glow),
          0 0 90px var(--orange-glow);
      }
      50% {
        transform: translateY(-8px);
        text-shadow: 
          0 0 40px var(--orange-glow),
          0 0 80px var(--orange-glow),
          0 0 120px var(--orange-glow);
      }
    }

    @keyframes buttonShine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      50%, 100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    @keyframes bossWarningPulse {
      0%, 100% { 
        opacity: 1;
        transform: scale(1);
      }
      50% { 
        opacity: 0.7;
        transform: scale(1.05);
      }
    }

    @keyframes newRecordFlash {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.1);
      }
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
    }

    body {
      margin: 0;
      padding: 0;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      position: relative;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(2px 2px at 20% 30%, white, transparent),
        radial-gradient(2px 2px at 60% 70%, white, transparent),
        radial-gradient(1px 1px at 50% 50%, white, transparent),
        radial-gradient(1px 1px at 80% 10%, white, transparent),
        radial-gradient(2px 2px at 90% 60%, white, transparent),
        radial-gradient(1px 1px at 33% 80%, white, transparent),
        radial-gradient(1px 1px at 70% 40%, white, transparent),
        radial-gradient(3px 3px at 15% 65%, rgba(255, 102, 0, 0.8), transparent),
        linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #2a3456 100%);
      background-size: 200% 200%;
      animation: starTwinkle 3s ease-in-out infinite;
      z-index: 0;
    }

    .start-screen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 300;
      background: radial-gradient(ellipse at center, rgba(10, 14, 39, 0.98) 0%, rgba(0, 0, 0, 0.99) 100%);
      backdrop-filter: blur(20px);
      animation: fadeInScale 1s ease;
      padding: max(var(--safe-area-top), 20px) 20px max(var(--safe-area-bottom), 20px);
    }

    .start-screen.hidden {
      display: none;
    }

    .scan-effect {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
    }

    .scan-line {
      position: absolute;
      width: 100%;
      height: 4px;
      background: linear-gradient(transparent, rgba(255, 102, 0, 0.8), transparent);
      box-shadow: 0 0 30px var(--orange-glow), 0 0 60px var(--orange-glow);
      animation: scanLine 6s linear infinite;
    }

    .meteor {
      position: absolute;
      width: 3px;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--ubi-orange));
      border-radius: 50%;
      box-shadow: 0 0 10px var(--ubi-orange);
    }

    .meteor:nth-child(1) {
      top: 10%;
      left: 20%;
      animation: meteorShower 3s ease-in-out infinite;
    }

    .meteor:nth-child(2) {
      top: 30%;
      left: 60%;
      animation: meteorShower 4s ease-in-out infinite;
      animation-delay: 1s;
    }

    .meteor:nth-child(3) {
      top: 50%;
      left: 80%;
      animation: meteorShower 3.5s ease-in-out infinite;
      animation-delay: 2s;
    }

    .zayni-logo {
      position: absolute;
      top: 30px;
      left: 30px;
      font-family: 'Arial Black', sans-serif;
      font-size: 22px;
      font-weight: 900;
      color: var(--ubi-orange);
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 0 0 20px var(--orange-glow);
    }

    .zayni-logo::before {
      content: "â¬¢";
      margin-right: 8px;
      color: var(--ubi-blue);
    }

    .logo-container {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo-icon {
      font-size: 80px;
      margin-bottom: 16px;
      filter: drop-shadow(0 0 30px var(--orange-glow));
      animation: float 3s ease-in-out infinite;
    }

    .logo-text {
      font-size: 48px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--ubi-orange) 0%, var(--ubi-blue) 50%, var(--ubi-orange) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-transform: uppercase;
      letter-spacing: 8px;
      margin-bottom: 8px;
      animation: glitchText 5s ease-in-out infinite;
      font-family: 'Arial Black', sans-serif;
    }

    .logo-subtitle {
      font-size: 14px;
      font-weight: 600;
      color: rgba(255, 102, 0, 0.7);
      text-transform: uppercase;
      letter-spacing: 4px;
      margin-bottom: 16px;
    }

    .highscore-display {
      background: rgba(10, 14, 39, 0.8);
      border: 2px solid rgba(255, 215, 0, 0.4);
      border-radius: 16px;
      padding: 12px 24px;
      margin-bottom: 20px;
      text-align: center;
    }

    .highscore-label {
      font-size: 10px;
      color: rgba(255, 215, 0, 0.6);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 4px;
    }

    .highscore-value {
      font-size: 32px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--ubi-yellow) 0%, var(--ubi-orange) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-family: "SF Mono", monospace;
      letter-spacing: -1px;
    }

    .highscore-player {
      font-size: 14px;
      color: var(--ubi-blue);
      margin-top: 4px;
      font-weight: 700;
    }

    .username-section {
      margin-bottom: 30px;
      text-align: center;
    }

    .username-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .username-input {
      background: rgba(10, 14, 39, 0.9);
      border: 2px solid rgba(0, 153, 255, 0.4);
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 18px;
      font-weight: 700;
      color: white;
      text-align: center;
      width: 280px;
      max-width: 90%;
      font-family: inherit;
      outline: none;
      transition: all 0.3s ease;
    }

    .username-input:focus {
      border-color: var(--ubi-orange);
      box-shadow: 0 0 20px var(--orange-glow);
    }

    .username-input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .ready-section {
      text-align: center;
      margin-bottom: 30px;
    }

    .ready-text {
      font-size: 28px;
      font-weight: 800;
      color: var(--ubi-orange);
      text-transform: uppercase;
      letter-spacing: 4px;
      margin-bottom: 12px;
      animation: floatText 3s ease-in-out infinite;
      font-family: 'Arial Black', sans-serif;
      line-height: 1.4;
    }

    .ready-subtitle {
      font-size: 18px;
      color: #0099FF;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 700;
      text-shadow: 0 0 20px var(--blue-glow);
    }

    .start-button {
      background: linear-gradient(135deg, var(--ubi-orange) 0%, #cc5200 100%);
      color: white;
      border: 3px solid rgba(255, 102, 0, 0.5);
      padding: 18px 50px;
      border-radius: 50px;
      font-size: 20px;
      font-weight: 900;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 3px;
      box-shadow: 
        0 0 30px var(--orange-glow),
        0 8px 24px rgba(0, 0, 0, 0.4),
        inset 0 2px 0 rgba(255, 255, 255, 0.4),
        inset 0 -2px 0 rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      animation: buttonGlow 2s ease-in-out infinite;
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .start-button::after {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transform: rotate(45deg);
      animation: buttonShine 3s ease-in-out infinite;
    }

    .start-button:active {
      transform: scale(0.96);
    }

    .button-container {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .instruction-text {
      margin-top: 20px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      text-align: center;
      padding: 0 20px;
      line-height: 1.6;
    }

    .feature-badges {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .badge {
      background: rgba(255, 102, 0, 0.1);
      border: 1px solid rgba(255, 102, 0, 0.3);
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 10px;
      color: var(--ubi-orange);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
    }

    .badge.green {
      background: rgba(0, 255, 102, 0.1);
      border-color: rgba(0, 255, 102, 0.3);
      color: var(--ubi-green);
    }

    #game-container {
      position: fixed;
      inset: 0;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      padding-top: max(var(--safe-area-top), 0px);
      padding-bottom: max(var(--safe-area-bottom), 0px);
    }

    #game-container.active {
      opacity: 1;
    }

    canvas {
      display: block;
      touch-action: none;
    }

    .hud {
      position: fixed;
      top: max(calc(var(--safe-area-top) + 8px), 8px);
      left: 8px;
      right: 8px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      z-index: 100;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.5s ease 0.3s;
      pointer-events: none;
    }

    .hud.active {
      opacity: 1;
    }

    .glass-card {
      background: rgba(10, 14, 39, 0.9);
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      border-radius: 16px;
      border: 2px solid rgba(255, 102, 0, 0.3);
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.5),
        0 0 20px var(--orange-glow),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      padding: 12px 16px;
    }

    .score-card {
      flex: 1;
      max-width: 140px;
    }

    .stat-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .score-label {
      font-size: 8px;
      font-weight: 700;
      color: var(--ubi-orange);
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.8;
    }

    .score-value {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--ubi-orange) 0%, var(--ubi-blue) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-family: "SF Mono", "Monaco", "Courier New", monospace;
      letter-spacing: -1px;
      line-height: 1;
    }

    .health-card {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .health-label {
      font-size: 8px;
      font-weight: 700;
      color: var(--ubi-red);
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.8;
    }

    .hearts {
      display: flex;
      gap: 6px;
    }

    .heart {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--ubi-orange) 0%, var(--ubi-red) 100%);
      clip-path: polygon(50% 0, 100% 25%, 100% 75%, 50% 100%, 0 75%, 0 25%);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 
        0 4px 12px rgba(255, 102, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      color: white;
      font-size: 16px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .heart.lost {
      background: rgba(60, 60, 80, 0.3);
      box-shadow: none;
      transform: scale(0.7) rotate(180deg);
      opacity: 0.2;
    }

    .wave-badge {
      background: linear-gradient(135deg, rgba(255, 102, 0, 0.15) 0%, rgba(0, 153, 255, 0.15) 100%);
      border: 2px solid rgba(255, 102, 0, 0.5);
      padding: 10px 16px;
      border-radius: 50px;
      color: var(--ubi-orange);
      font-weight: 800;
      font-size: 14px;
      letter-spacing: 1.5px;
      text-shadow: 0 0 20px var(--orange-glow);
      box-shadow: 
        0 0 20px var(--orange-glow),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .boss-health-container {
      position: fixed;
      top: max(calc(var(--safe-area-top) + 80px), 80px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      width: 90%;
      max-width: 400px;
      display: none;
    }

    .boss-health-container.active {
      display: block;
    }

    .boss-label {
      text-align: center;
      font-size: 16px;
      font-weight: 900;
      color: var(--ubi-red);
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 8px;
      text-shadow: 0 0 20px rgba(255, 0, 51, 0.8);
      animation: bossWarningPulse 1s ease-in-out infinite;
    }

    .boss-health-bar-bg {
      background: rgba(10, 14, 39, 0.9);
      border: 3px solid var(--ubi-red);
      border-radius: 20px;
      padding: 8px;
      box-shadow: 0 0 30px rgba(255, 0, 51, 0.5);
    }

    .boss-health-bar {
      height: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .boss-health-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--ubi-red), var(--ubi-orange), var(--ubi-yellow));
      border-radius: 12px;
      transition: width 0.3s ease;
      box-shadow: 0 0 20px rgba(255, 102, 0, 0.8);
    }

    .boss-warning {
      position: fixed;
      top: 50%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      z-index: 150;
      text-align: center;
      font-size: 64px;
      font-weight: 900;
      color: var(--ubi-red);
      text-transform: uppercase;
      letter-spacing: 12px;
      text-shadow: 
        0 0 40px rgba(255, 0, 51, 0.8),
        0 0 80px rgba(255, 0, 51, 0.6),
        0 4px 8px rgba(0, 0, 0, 0.8);
      animation: bossWarningPulse 0.6s ease-in-out;
      pointer-events: none;
      display: none;
      background: rgba(0, 0, 0, 0.7);
      padding: 30px 20px;
      border-top: 4px solid var(--ubi-red);
      border-bottom: 4px solid var(--ubi-red);
    }

    .boss-warning.active {
      display: block;
    }

    .difficulty-indicator {
      position: fixed;
      bottom: max(calc(var(--safe-area-bottom) + 12px), 12px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      background: rgba(10, 14, 39, 0.9);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 102, 0, 0.3);
      border-radius: 16px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      opacity: 0;
      transition: opacity 0.5s ease 0.3s;
    }

    .difficulty-indicator.active {
      opacity: 1;
    }

    .difficulty-label {
      font-size: 9px;
      font-weight: 700;
      color: var(--ubi-orange);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .difficulty-bar {
      width: 80px;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      overflow: hidden;
    }

    .difficulty-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--ubi-blue), var(--ubi-orange), var(--ubi-red));
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.92);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      z-index: 200;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.4s ease;
      padding: max(var(--safe-area-top), 20px) 20px max(var(--safe-area-bottom), 20px);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(145deg, rgba(10, 14, 39, 0.98), rgba(26, 31, 58, 0.98));
      backdrop-filter: blur(40px);
      border-radius: 28px;
      border: 2px solid rgba(255, 102, 0, 0.3);
      padding: 32px;
      text-align: center;
      box-shadow: 
        0 24px 64px rgba(0, 0, 0, 0.7),
        0 0 80px var(--orange-glow),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      animation: slideUp 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-width: 90%;
      width: 400px;
    }

    @keyframes slideUp {
      from { transform: translateY(60px) scale(0.9); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .modal-title {
      font-size: 36px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--ubi-red) 0%, var(--ubi-orange) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0 0 20px 0;
      letter-spacing: -2px;
      text-transform: uppercase;
    }

    .new-record-badge {
      display: none;
      background: linear-gradient(135deg, var(--ubi-yellow) 0%, var(--ubi-orange) 100%);
      color: #000;
      font-size: 14px;
      font-weight: 900;
      padding: 8px 20px;
      border-radius: 20px;
      margin: 0 auto 16px;
      width: fit-content;
      text-transform: uppercase;
      letter-spacing: 2px;
      animation: newRecordFlash 1s ease-in-out infinite;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
    }

    .new-record-badge.active {
      display: block;
    }

    .modal-score {
      font-size: 56px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--ubi-orange) 0%, var(--ubi-yellow) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-family: "SF Mono", "Monaco", monospace;
      margin: 0 0 16px 0;
      letter-spacing: -2px;
    }

    .modal-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 16px 0 28px 0;
      flex-wrap: wrap;
    }

    .modal-stat {
      text-align: center;
    }

    .modal-stat-label {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 6px;
    }

    .modal-stat-value {
      font-size: 22px;
      font-weight: 800;
      color: var(--ubi-orange);
      font-family: monospace;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .modal-button {
      background: linear-gradient(135deg, var(--ubi-orange) 0%, #cc5200 100%);
      color: white;
      border: none;
      padding: 14px 36px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 
        0 8px 24px var(--orange-glow),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .modal-button:active {
      transform: scale(0.95);
    }

    @media (min-width: 900px) {
      .logo-icon { font-size: 120px; }
      .logo-text { font-size: 64px; letter-spacing: 12px; }
      .logo-subtitle { font-size: 18px; letter-spacing: 6px; }
      .ready-text { font-size: 32px; letter-spacing: 5px; }
      .ready-subtitle { font-size: 22px; letter-spacing: 4px; }
      .start-button { padding: 22px 70px; font-size: 24px; }
      .instruction-text { font-size: 14px; }
      .hud { top: calc(var(--safe-area-top) + 24px); left: 24px; right: 24px; gap: 16px; }
      .glass-card { padding: 20px 28px; border-radius: 20px; }
      .score-card { max-width: 220px; }
      .score-value { font-size: 42px; }
      .score-label, .health-label { font-size: 10px; }
      .heart { width: 42px; height: 42px; }
      .wave-badge { font-size: 18px; padding: 14px 28px; }
      .difficulty-bar { width: 120px; height: 6px; }
      .difficulty-label { font-size: 12px; }
      .difficulty-indicator { bottom: calc(var(--safe-area-bottom) + 24px); padding: 12px 24px; }
      .modal-content { padding: 56px 64px; max-width: 500px; }
      .modal-title { font-size: 52px; }
      .modal-score { font-size: 80px; }
      .modal-stat-value { font-size: 28px; }
      .zayni-logo { font-size: 24px; }
      .boss-label { font-size: 20px; }
      .boss-health-bar { height: 24px; }
      .boss-warning { font-size: 80px; padding: 40px 30px; }
      .highscore-value { font-size: 40px; }
    }
.shop-button{background:linear-gradient(135deg,var(--ubi-yellow) 0%,var(--ubi-orange) 100%);color:#000;border:3px solid rgba(255,215,0,0.5);padding:14px 40px;border-radius:50px;font-size:18px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:2px;box-shadow:0 0 30px rgba(255,215,0,0.4),0 8px 20px rgba(0,0,0,0.4);transition:all 0.3s ease;margin-top:16px}.shop-button:hover{transform:scale(1.05);box-shadow:0 0 40px rgba(255,215,0,0.6)}.shop-button:active{transform:scale(0.96)}.pass-button{background:linear-gradient(135deg,#9D4EDD 0%,#7B2CBF 100%);color:white;border:3px solid rgba(157,78,221,0.5);padding:14px 40px;border-radius:50px;font-size:18px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:2px;box-shadow:0 0 30px rgba(157,78,221,0.4),0 8px 20px rgba(0,0,0,0.4);transition:all 0.3s ease;margin-top:16px}.pass-button:hover{transform:scale(1.05);box-shadow:0 0 40px rgba(157,78,221,0.6)}.pass-button:active{transform:scale(0.96)}.shop-panel,.pass-panel{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:500;align-items:center;justify-content:center;padding:20px;overflow-y:auto}.shop-panel.active,.pass-panel.active{display:flex}.shop-content,.pass-content{background:linear-gradient(145deg,rgba(10,14,39,0.98),rgba(26,31,58,0.98));border:3px solid var(--ubi-yellow);border-radius:24px;padding:40px;max-width:900px;width:100%;box-shadow:0 0 80px rgba(255,215,0,0.6);max-height:90vh;overflow-y:auto}.pass-content{border-color:#9D4EDD;box-shadow:0 0 80px rgba(157,78,221,0.6)}.shop-header,.pass-header{text-align:center;margin-bottom:30px}.shop-title{font-size:36px;font-weight:900;background:linear-gradient(135deg,var(--ubi-yellow) 0%,var(--ubi-orange) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-transform:uppercase;letter-spacing:4px;margin-bottom:12px}.pass-title{font-size:32px;font-weight:900;background:linear-gradient(135deg,#9D4EDD 0%,#FF006E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-transform:uppercase;letter-spacing:3px;margin-bottom:16px}.pass-progress{display:flex;justify-content:space-between;margin-bottom:12px;font-size:16px;font-weight:800;color:#9D4EDD}.pass-level{color:#FF006E}.pass-xp{color:#9D4EDD}.pass-bar-bg{width:100%;height:20px;background:rgba(157,78,221,0.2);border-radius:10px;overflow:hidden;border:2px solid rgba(157,78,221,0.4)}.pass-bar-fill{height:100%;background:linear-gradient(90deg,#9D4EDD 0%,#FF006E 100%);border-radius:8px;transition:width 0.5s ease;box-shadow:0 0 20px rgba(157,78,221,0.6)}.section-title{font-size:20px;font-weight:900;color:#9D4EDD;text-transform:uppercase;letter-spacing:2px;margin:20px 0 16px 0;text-align:center}.quests-section,.rewards-section{margin-bottom:30px}.quests-grid{display:grid;gap:12px}.quest-card{background:rgba(157,78,221,0.1);border:2px solid rgba(157,78,221,0.3);border-radius:12px;padding:16px;display:flex;justify-content:space-between;align-items:center;transition:all 0.3s ease}.quest-card.complete{border-color:var(--ubi-green);background:rgba(0,255,102,0.1)}.quest-info{flex:1}.quest-name{font-size:14px;font-weight:800;color:#9D4EDD;margin-bottom:4px}.quest-card.complete .quest-name{color:var(--ubi-green)}.quest-progress{font-size:12px;color:#888;font-weight:600}.quest-reward{background:linear-gradient(135deg,#9D4EDD 0%,#7B2CBF 100%);color:white;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:1px}.quest-card.complete .quest-reward{background:linear-gradient(135deg,var(--ubi-green) 0%,#00CC55 100%);color:#000}.rewards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}.reward-card{background:rgba(157,78,221,0.1);border:2px solid rgba(157,78,221,0.3);border-radius:12px;padding:16px;text-align:center;transition:all 0.3s ease}.reward-card.unlocked{border-color:var(--ubi-green);background:rgba(0,255,102,0.1);box-shadow:0 0 20px rgba(0,255,102,0.4)}.reward-card.chroma{border-color:#FF006E;background:linear-gradient(135deg,rgba(157,78,221,0.2),rgba(255,0,110,0.2));box-shadow:0 0 30px rgba(255,0,110,0.6);animation:chromaPulse 2s ease-in-out infinite}@keyframes chromaPulse{0%,100%{box-shadow:0 0 30px rgba(255,0,110,0.6)}50%{box-shadow:0 0 50px rgba(157,78,221,0.8)}}.reward-icon{font-size:48px;margin-bottom:8px;filter:drop-shadow(0 0 10px rgba(157,78,221,0.6))}.reward-card.chroma .reward-icon{animation:chromaSpin 3s linear infinite}@keyframes chromaSpin{0%{filter:drop-shadow(0 0 10px #FF006E) hue-rotate(0deg)}100%{filter:drop-shadow(0 0 10px #9D4EDD) hue-rotate(360deg)}}.reward-name{font-size:12px;font-weight:800;color:#9D4EDD;margin-bottom:4px;text-transform:uppercase}.reward-card.unlocked .reward-name{color:var(--ubi-green)}.reward-level{font-size:10px;color:#888;font-weight:600}.shop-balance{font-size:24px;font-weight:800;color:var(--ubi-yellow);text-shadow:0 0 20px rgba(255,215,0,0.6)}.ships-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:30px}.ship-card{background:rgba(10,14,39,0.8);border:2px solid rgba(255,215,0,0.3);border-radius:12px;padding:12px;transition:all 0.3s ease;cursor:pointer}.ship-card:hover{transform:translateY(-5px);border-color:var(--ubi-yellow);box-shadow:0 0 30px rgba(255,215,0,0.4)}.ship-card.owned{border-color:var(--ubi-green);background:rgba(0,255,102,0.05)}.ship-card.equipped{border-color:var(--ubi-orange);background:rgba(255,102,0,0.1);box-shadow:0 0 30px var(--orange-glow)}.ship-icon{font-size:36px;text-align:center;margin-bottom:8px;filter:drop-shadow(0 0 10px rgba(255,215,0,0.6))}.ship-name{font-size:12px;font-weight:900;color:var(--ubi-yellow);text-align:center;margin-bottom:4px;text-transform:uppercase;letter-spacing:1px}.ship-price{font-size:14px;font-weight:800;color:var(--ubi-orange);text-align:center;margin-bottom:8px}.ship-status{text-align:center;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;padding:4px;border-radius:6px}.ship-status.owned{background:rgba(0,255,102,0.2);color:var(--ubi-green)}.ship-status.equipped{background:rgba(255,102,0,0.3);color:var(--ubi-orange)}.shop-close-btn{width:100%;background:linear-gradient(135deg,#666 0%,#444 100%);color:white;border:none;padding:16px;border-radius:12px;font-size:16px;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:1px;transition:all 0.3s ease}.shop-close-btn:hover{transform:scale(1.02)}.admin-button{
  position: fixed;
  top: 30px;
  left: 30px;
  background: linear-gradient(135deg, rgba(255, 0, 51, 0.3), rgba(204, 0, 41, 0.3));
  border: 3px solid rgba(255, 0, 51, 0.5);
  color: var(--ubi-red);
  padding: 10px 20px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 900;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 2px;
  transition: all 0.3s ease;
  z-index: 400;
  box-shadow: 0 0 20px rgba(255, 0, 51, 0.4);
}

.admin-button:hover {
  background: rgba(255, 0, 51, 0.4);
  box-shadow: 0 0 30px rgba(255, 0, 51, 0.6);
  transform: scale(1.05);
}

.admin-button:active {
  transform: scale(0.96);
}.admin-button:hover{background:rgba(255,0,51,0.3);box-shadow:0 0 20px rgba(255,0,51,0.6)}.admin-panel{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:500;align-items:center;justify-content:center;padding:20px}.admin-panel.active{display:flex}.admin-content{background:linear-gradient(145deg,rgba(10,14,39,0.98),rgba(26,31,58,0.98));border:2px solid var(--ubi-red);border-radius:20px;padding:40px;max-width:400px;width:100%;box-shadow:0 0 60px rgba(255,0,51,0.6)}.admin-title{font-size:24px;font-weight:900;color:var(--ubi-red);text-transform:uppercase;letter-spacing:3px;margin-bottom:20px;text-align:center}.admin-input{width:100%;background:rgba(10,14,39,0.9);border:2px solid rgba(255,0,51,0.4);border-radius:12px;padding:12px 20px;font-size:16px;font-weight:700;color:white;text-align:center;font-family:inherit;outline:none;margin-bottom:16px}.admin-input:focus{border-color:var(--ubi-red);box-shadow:0 0 20px rgba(255,0,51,0.4)}.admin-buttons{display:flex;gap:12px}.admin-action-btn{flex:1;background:linear-gradient(135deg,var(--ubi-red) 0%,#cc0029 100%);color:white;border:none;padding:12px 24px;border-radius:12px;font-size:14px;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:1px;transition:all 0.3s ease}.admin-action-btn:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(255,0,51,0.6)}.admin-action-btn.cancel{background:linear-gradient(135deg,#666 0%,#444 100%)}.error-toast,.quest-complete-toast,.levelup-toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:600;border-radius:20px;padding:30px 50px;display:none;animation:toastBounce 0.5s ease-in-out}@keyframes toastBounce{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.1)}}.error-toast{background:linear-gradient(135deg,rgba(255,0,51,0.95),rgba(204,0,41,0.95));border:4px solid var(--ubi-red);box-shadow:0 0 60px rgba(255,0,51,0.8)}.quest-complete-toast{background:linear-gradient(135deg,rgba(157,78,221,0.95),rgba(123,44,191,0.95));border:4px solid #9D4EDD;box-shadow:0 0 60px rgba(157,78,221,0.8)}.levelup-toast{background:linear-gradient(135deg,rgba(255,0,110,0.95),rgba(157,78,221,0.95));border:4px solid #FF006E;box-shadow:0 0 60px rgba(255,0,110,0.8)}.error-toast.active,.quest-complete-toast.active,.levelup-toast.active{display:block}.error-text,.quest-text,.levelup-text{font-size:28px;font-weight:900;color:white;text-align:center;text-transform:uppercase;letter-spacing:2px;text-shadow:0 4px 8px rgba(0,0,0,0.6);margin:0}
  
    .box-button{background:linear-gradient(135deg,#FF006E 0%,#9D4EDD 100%);color:white;border:3px solid rgba(255,0,110,0.5);padding:14px 40px;border-radius:50px;font-size:18px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:2px;box-shadow:0 0 30px rgba(255,0,110,0.4),0 8px 20px rgba(0,0,0,0.4);transition:all 0.3s ease;margin-top:16px}.box-button:hover{transform:scale(1.05);box-shadow:0 0 40px rgba(255,0,110,0.6)}.box-button:active{transform:scale(0.96)}.box-panel{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:500;align-items:center;justify-content:center;padding:20px;overflow-y:auto}.box-panel.active{display:flex}.box-content{background:linear-gradient(145deg,rgba(10,14,39,0.98),rgba(26,31,58,0.98));border:3px solid #FF006E;border-radius:24px;padding:40px;max-width:900px;width:100%;box-shadow:0 0 80px rgba(255,0,110,0.6);max-height:90vh;overflow-y:auto}.box-header{text-align:center;margin-bottom:30px}.box-title{font-size:36px;font-weight:900;background:linear-gradient(135deg,#FF006E 0%,#9D4EDD 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-transform:uppercase;letter-spacing:4px;margin-bottom:12px}.currency-container{display:flex;gap:16px;justify-content:center;align-items:center;flex-wrap:wrap}.box-balance{font-size:24px;font-weight:800;color:var(--ubi-yellow);text-shadow:0 0 20px rgba(255,215,0,0.6)}.gem-display{display:inline-flex;align-items:center;gap:8px;background:rgba(157,78,221,0.2);border:2px solid rgba(157,78,221,0.5);padding:8px 16px;border-radius:20px;font-size:20px;font-weight:900;color:#9D4EDD;text-shadow:0 0 10px rgba(157,78,221,0.6);box-shadow:0 0 20px rgba(157,78,221,0.3);animation:gemShine 2s ease-in-out infinite}@keyframes gemShine{0%,100%{box-shadow:0 0 20px rgba(157,78,221,0.3)}50%{box-shadow:0 0 30px rgba(157,78,221,0.6)}}.gem-icon{font-size:24px;filter:drop-shadow(0 0 8px rgba(157,78,221,0.8))}.shop-gems{font-size:20px;font-weight:800;color:#9D4EDD;text-shadow:0 0 15px rgba(157,78,221,0.6);display:inline-flex;align-items:center;gap:6px}.boxes-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}.box-card{background:linear-gradient(145deg,rgba(10,14,39,0.9),rgba(26,31,58,0.9));border:3px solid;border-radius:16px;padding:24px;text-align:center;transition:all 0.3s ease;cursor:pointer;position:relative;overflow:hidden}.box-card:hover{transform:translateY(-8px);box-shadow:0 12px 40px rgba(0,0,0,0.6)}.box-card.basic{border-color:#888;box-shadow:0 0 20px rgba(136,136,136,0.3)}.box-card.basic:hover{box-shadow:0 0 40px rgba(136,136,136,0.5),0 12px 40px rgba(0,0,0,0.6)}.box-card.premium{border-color:#9D4EDD;box-shadow:0 0 20px rgba(157,78,221,0.4)}.box-card.premium:hover{box-shadow:0 0 40px rgba(157,78,221,0.6),0 12px 40px rgba(0,0,0,0.6)}.box-card.legendary{border-color:#FFD700;box-shadow:0 0 30px rgba(255,215,0,0.5);animation:legendaryGlow 2s ease-in-out infinite}.box-card.legendary:hover{box-shadow:0 0 60px rgba(255,215,0,0.8),0 12px 40px rgba(0,0,0,0.6)}@keyframes legendaryGlow{0%,100%{box-shadow:0 0 30px rgba(255,215,0,0.5),0 4px 16px rgba(0,0,0,0.4)}50%{box-shadow:0 0 50px rgba(255,215,0,0.8),0 8px 24px rgba(255,215,0,0.4)}}.box-card.mythic{border-color:#FF006E;box-shadow:0 0 40px rgba(255,0,110,0.6);animation:mythicPulse 1.5s ease-in-out infinite}@keyframes mythicPulse{0%,100%{box-shadow:0 0 40px rgba(255,0,110,0.6),0 0 20px rgba(157,78,221,0.4)}50%{box-shadow:0 0 60px rgba(255,0,110,0.9),0 0 40px rgba(157,78,221,0.6)}}.box-icon{font-size:80px;margin-bottom:16px;filter:drop-shadow(0 0 20px rgba(255,0,110,0.6));animation:floatBox 3s ease-in-out infinite}@keyframes floatBox{0%,100%{transform:translateY(0px)}50%{transform:translateY(-10px)}}.box-name{font-size:20px;font-weight:900;text-transform:uppercase;letter-spacing:2px;margin-bottom:12px}.box-card.basic .box-name{color:#AAA}.box-card.premium .box-name{color:#9D4EDD}.box-card.legendary .box-name{background:linear-gradient(135deg,#FFD700 0%,#FF6600 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.box-card.mythic .box-name{background:linear-gradient(135deg,#FF006E 0%,#9D4EDD 50%,#FFD700 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.box-description{font-size:12px;color:#888;margin-bottom:16px;line-height:1.4}.box-price{font-size:28px;font-weight:900;color:var(--ubi-yellow);text-shadow:0 0 10px rgba(255,215,0,0.4);margin-bottom:16px}.buy-box-btn{background:linear-gradient(135deg,var(--ubi-orange) 0%,#cc5200 100%);color:white;border:none;padding:12px 32px;border-radius:50px;font-size:14px;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:1px;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.4)}.buy-box-btn:hover{transform:scale(1.05);box-shadow:0 6px 16px rgba(255,102,0,0.6)}.buy-box-btn:active{transform:scale(0.95)}.opening-animation{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.98);z-index:600;align-items:center;justify-content:center;flex-direction:column}.opening-animation.active{display:flex}.opening-box{font-size:200px;animation:spinBox 2s ease-in-out;filter:drop-shadow(0 0 60px rgba(255,0,110,0.8));}@keyframes spinBox{0%{transform:rotate(0deg) scale(0.5);opacity:0}50%{transform:rotate(360deg) scale(1.3)}100%{transform:rotate(720deg) scale(1);opacity:1}}.opening-text{font-size:32px;font-weight:900;color:white;text-transform:uppercase;letter-spacing:4px;margin-top:30px;animation:pulse 1s ease-in-out infinite}@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.7;transform:scale(1.1)}}.reward-reveal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.98);z-index:600;align-items:center;justify-content:center;flex-direction:column;animation:fadeIn 0.5s ease}.reward-reveal.active{display:flex}.reward-card-big{background:linear-gradient(145deg,rgba(10,14,39,0.95),rgba(26,31,58,0.95));border:4px solid;border-radius:24px;padding:50px;text-align:center;min-width:400px;animation:revealPop 0.6s cubic-bezier(0.68,-0.55,0.265,1.55);}@keyframes revealPop{0%{transform:scale(0) rotate(-180deg);opacity:0}100%{transform:scale(1) rotate(0deg);opacity:1}}.reward-card-big.common{border-color:#888;box-shadow:0 0 60px rgba(136,136,136,0.6)}.reward-card-big.rare{border-color:#0099FF;box-shadow:0 0 60px rgba(0,153,255,0.8)}.reward-card-big.epic{border-color:#9D4EDD;box-shadow:0 0 60px rgba(157,78,221,0.8)}.reward-card-big.legendary{border-color:#FFD700;box-shadow:0 0 80px rgba(255,215,0,1);animation:revealPop 0.6s cubic-bezier(0.68,-0.55,0.265,1.55),legendaryShine 2s ease-in-out infinite}@keyframes legendaryShine{0%,100%{box-shadow:0 0 80px rgba(255,215,0,1),0 0 40px rgba(255,102,0,0.6)}50%{box-shadow:0 0 120px rgba(255,215,0,1),0 0 60px rgba(255,102,0,0.8)}}.reward-card-big.mythic{border-color:#FF006E;box-shadow:0 0 100px rgba(255,0,110,1);animation:revealPop 0.6s cubic-bezier(0.68,-0.55,0.265,1.55),mythicShimmer 1.5s ease-in-out infinite}@keyframes mythicShimmer{0%,100%{box-shadow:0 0 100px rgba(255,0,110,1),0 0 50px rgba(157,78,221,0.8)}50%{box-shadow:0 0 140px rgba(255,0,110,1),0 0 70px rgba(157,78,221,1)}}.rarity-badge{font-size:16px;font-weight:900;text-transform:uppercase;letter-spacing:3px;margin-bottom:20px;padding:8px 24px;border-radius:20px;display:inline-block}.rarity-badge.common{background:rgba(136,136,136,0.3);color:#AAA;border:2px solid #888}.rarity-badge.rare{background:rgba(0,153,255,0.3);color:#0099FF;border:2px solid #0099FF}.rarity-badge.epic{background:rgba(157,78,221,0.3);color:#9D4EDD;border:2px solid #9D4EDD}.rarity-badge.legendary{background:linear-gradient(135deg,rgba(255,215,0,0.3),rgba(255,102,0,0.3));color:#FFD700;border:2px solid #FFD700}.rarity-badge.mythic{background:linear-gradient(135deg,rgba(255,0,110,0.3),rgba(157,78,221,0.3));color:#FF006E;border:2px solid #FF006E}.reward-icon-big{font-size:120px;margin:20px 0;filter:drop-shadow(0 0 30px rgba(255,0,110,0.6));animation:rewardFloat 2s ease-in-out infinite}@keyframes rewardFloat{0%,100%{transform:translateY(0px) rotate(0deg)}50%{transform:translateY(-15px) rotate(5deg)}}.reward-name-big{font-size:28px;font-weight:900;margin-bottom:16px;text-transform:uppercase;letter-spacing:2px}.reward-card-big.common .reward-name-big{color:#AAA}.reward-card-big.rare .reward-name-big{color:#0099FF}.reward-card-big.epic .reward-name-big{color:#9D4EDD}.reward-card-big.legendary .reward-name-big{background:linear-gradient(135deg,#FFD700 0%,#FF6600 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.reward-card-big.mythic .reward-name-big{background:linear-gradient(135deg,#FF006E 0%,#9D4EDD 50%,#FFD700 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.reward-description{font-size:16px;color:#888;margin-bottom:24px;line-height:1.6}.claim-reward-btn{background:linear-gradient(135deg,var(--ubi-orange) 0%,#cc5200 100%);color:white;border:none;padding:16px 48px;border-radius:50px;font-size:18px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:2px;transition:all 0.3s ease;box-shadow:0 8px 20px rgba(255,102,0,0.6)}.claim-reward-btn:hover{transform:scale(1.05);box-shadow:0 10px 24px rgba(255,102,0,0.8)}.claim-reward-btn:active{transform:scale(0.95)}

.wheel-button{background:linear-gradient(135deg,#FF1493 0%,#FF69B4 100%);color:white;border:3px solid rgba(255,20,147,0.5);padding:14px 40px;border-radius:50px;font-size:18px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:2px;box-shadow:0 0 30px rgba(255,20,147,0.4),0 8px 20px rgba(0,0,0,0.4);transition:all 0.3s ease;margin-top:16px;position:relative;overflow:hidden}
.wheel-button:hover{transform:scale(1.05);box-shadow:0 0 40px rgba(255,20,147,0.6)}
.wheel-button:active{transform:scale(0.96)}
.wheel-button::after{content:"";position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent,rgba(255,255,255,0.3),transparent);transform:rotate(45deg);animation:buttonShine 3s ease-in-out infinite}
.wheel-panel{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:500;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
.wheel-panel.active{display:flex}
.wheel-content{background:linear-gradient(145deg,rgba(10,14,39,0.98),rgba(26,31,58,0.98));border:3px solid #FF1493;border-radius:24px;padding:40px;max-width:600px;width:100%;box-shadow:0 0 80px rgba(255,20,147,0.6);max-height:90vh;overflow-y:auto}
.wheel-header{text-align:center;margin-bottom:30px}
.wheel-title{font-size:36px;font-weight:900;background:linear-gradient(135deg,#FF1493 0%,#FF69B4 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-transform:uppercase;letter-spacing:4px;margin-bottom:20px}
.wheel-spins-display{display:flex;gap:20px;justify-content:center;align-items:center;flex-wrap:wrap;margin-bottom:20px}
.free-spins-badge{background:rgba(0,255,102,0.2);border:2px solid var(--ubi-green);padding:12px 24px;border-radius:20px;font-size:16px;font-weight:800;color:var(--ubi-green);text-transform:uppercase;letter-spacing:1px}
.paid-spins-badge{background:rgba(157,78,221,0.2);border:2px solid #9D4EDD;padding:12px 24px;border-radius:20px;font-size:16px;font-weight:800;color:#9D4EDD;text-transform:uppercase;letter-spacing:1px}
.wheel-container{position:relative;width:400px;height:400px;margin:30px auto;max-width:90%}
.wheel-canvas{width:100%;height:100%;border-radius:50%;box-shadow:0 0 60px rgba(255,20,147,0.6),inset 0 0 40px rgba(0,0,0,0.5);border:8px solid #FF1493;background:#000}
.wheel-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:80px;height:80px;background:linear-gradient(135deg,#FF1493 0%,#FF69B4 100%);border-radius:50%;border:5px solid white;box-shadow:0 0 40px rgba(255,20,147,1);z-index:10;display:flex;align-items:center;justify-content:center;font-size:32px;animation:centerPulse 2s ease-in-out infinite}
@keyframes centerPulse{0%,100%{box-shadow:0 0 40px rgba(255,20,147,1)}50%{box-shadow:0 0 60px rgba(255,20,147,1)}}
.wheel-pointer{position:absolute;top:-30px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:25px solid transparent;border-right:25px solid transparent;border-top:50px solid #FFD700;z-index:5;filter:drop-shadow(0 4px 12px rgba(0,0,0,0.8))}
.wheel-buttons{display:flex;gap:12px;justify-content:center;margin-top:30px;flex-wrap:wrap}
.spin-free-btn{background:linear-gradient(135deg,var(--ubi-green) 0%,#00CC55 100%);color:white;border:none;padding:14px 32px;border-radius:50px;font-size:16px;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:1px;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(0,255,102,0.4)}
.spin-free-btn:hover{transform:scale(1.05);box-shadow:0 6px 16px rgba(0,255,102,0.6)}
.spin-free-btn:active{transform:scale(0.95)}
.spin-free-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none}
.spin-paid-btn{background:linear-gradient(135deg,#9D4EDD 0%,#7B2CBF 100%);color:white;border:none;padding:14px 32px;border-radius:50px;font-size:16px;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:1px;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(157,78,221,0.4)}
.spin-paid-btn:hover{transform:scale(1.05);box-shadow:0 6px 16px rgba(157,78,221,0.6)}
.spin-paid-btn:active{transform:scale(0.95)}
.spin-paid-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none}
.wheel-close-btn{width:100%;background:linear-gradient(135deg,#666 0%,#444 100%);color:white;border:none;padding:16px;border-radius:12px;font-size:16px;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:1px;transition:all 0.3s ease;margin-top:20px}
.wheel-close-btn:hover{transform:scale(1.02)}
.wheel-result-popup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:700;background:linear-gradient(135deg,rgba(255,20,147,0.98),rgba(255,105,180,0.98));border:4px solid #FFD700;border-radius:24px;padding:40px 60px;box-shadow:0 0 80px rgba(255,215,0,0.8);animation:resultBounce 0.6s ease-in-out}
@keyframes resultBounce{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.15)}}
.wheel-result-popup.active{display:block}
.result-title{font-size:28px;font-weight:900;color:#FFD700;text-transform:uppercase;letter-spacing:3px;margin-bottom:20px;text-align:center;text-shadow:0 4px 8px rgba(0,0,0,0.6)}
.result-prize{font-size:64px;text-align:center;margin-bottom:20px;filter:drop-shadow(0 0 20px rgba(255,215,0,0.8))}
.result-description{font-size:20px;font-weight:800;color:white;text-align:center;margin-bottom:30px;text-shadow:0 2px 4px rgba(0,0,0,0.6)}
.result-claim-btn{width:100%;background:linear-gradient(135deg,#FFD700 0%,#FF6600 100%);color:#000;border:none;padding:16px;border-radius:50px;font-size:18px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:2px;transition:all 0.3s ease;box-shadow:0 6px 16px rgba(255,215,0,0.6)}
.result-claim-btn:hover{transform:scale(1.05)}
.result-claim-btn:active{transform:scale(0.95)}

  

.wheel-button{background:linear-gradient(135deg,#FF1493,#9D4EDD);color:white;border:3px solid rgba(255,20,147,0.5);padding:14px 40px;border-radius:50px;font-size:18px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:2px;margin-top:16px;transition:all 0.3s ease;}
.wheel-button:hover{transform:scale(1.05);} 
.wheel-button:active{transform:scale(0.96);} 
.wheel-panel{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:600;align-items:center;justify-content:center;padding:20px;} 
.wheel-panel.active{display:flex;} 
.wheel-content{background:linear-gradient(145deg,rgba(10,14,39,0.98),rgba(26,31,58,0.98));border-radius:24px;border:3px solid #FF1493;padding:40px;max-width:520px;width:100%;box-shadow:0 0 80px rgba(255,20,147,0.7);text-align:center;} 
.wheel-title{font-size:32px;font-weight:900;color:#FF1493;margin-bottom:6px;letter-spacing:3px;} 
.wheel-sub{font-size:18px;color:#9D4EDD;margin-bottom:6px;} 
.wheel-balance{font-size:16px;color:#FFD700;margin-bottom:20px;} 
.wheel-container{position:relative;width:360px;height:360px;margin:0 auto 24px;max-width:100%;} 
.wheel-pointer{position:absolute;top:-10px;left:50%;transform:translateX(-50%);font-size:36px;color:#FFD700;z-index:5;text-shadow:0 0 10px rgba(255,215,0,0.9);} 
#wheel-canvas{width:100%;height:100%;border-radius:50%;border:5px solid #FF1493;box-shadow:0 0 40px rgba(255,20,147,0.8);} 
.wheel-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#FFD700,#FF6600);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:16px;color:#000;border:4px solid #000;box-shadow:0 0 20px rgba(255,215,0,0.9);} 
.spin-btn{display:block;width:100%;margin-bottom:10px;background:linear-gradient(135deg,#9D4EDD,#FF1493);color:white;border:none;padding:16px 0;border-radius:999px;font-size:18px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:2px;box-shadow:0 0 30px rgba(157,78,221,0.7);transition:all 0.2s ease;} 
.spin-btn:disabled{opacity:0.5;cursor:not-allowed;} 
.spin-btn:hover:not(:disabled){transform:scale(1.03);} 
.wheel-close{width:100%;background:linear-gradient(135deg,#555,#333);color:white;border:none;padding:14px 0;border-radius:12px;font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:1px;cursor:pointer;} 
.wheel-result{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:650;align-items:center;justify-content:center;} 
.wheel-result.active{display:flex;} 
.wheel-result-card{background:linear-gradient(145deg,rgba(10,14,39,0.98),rgba(26,31,58,0.98));border-radius:24px;border:3px solid #FFD700;padding:40px 32px;text-align:center;min-width:320px;box-shadow:0 0 80px rgba(255,215,0,0.8);} 
.wheel-result-title{font-size:26px;font-weight:900;color:#FFD700;margin-bottom:10px;letter-spacing:2px;} 
.wheel-result-icon{font-size:64px;margin-bottom:10px;} 
.wheel-result-text{font-size:20px;font-weight:800;color:#FF1493;margin-bottom:20px;} 
.wheel-claim{width:100%;background:linear-gradient(135deg,#FFD700,#FF6600);color:#000;border:none;padding:14px 0;border-radius:999px;font-size:16px;font-weight:900;text-transform:uppercase;cursor:pointer;}
</style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.85.0/dist/phaser.js"></script>
</head>
<body>
<!-- Admin Buttons -->
<button class="admin-button" onclick="openAdminPanel()">ð ADMIN</button>
<button class="admin-button" style="top: 80px;" onclick="openAdminPanel2()">ð§ ADMIN+</button>



<div class="start-screen" id="start-screen">
  
  <div class="zayni-logo"></div>

  <div class="scan-effect">
    <div class="scan-line"></div>
    <div class="meteor"></div>
    <div class="meteor"></div>
    <div class="meteor"></div>
  </div>

  <div class="logo-container">
    <div class="logo-icon">ð¸</div>
    <div class="logo-text">ASTEROID</div>
    <div class="logo-subtitle">Defense Protocol</div>
  </div>

  <div class="highscore-display" id="highscore-display">
    <div class="highscore-label">ð High Score</div>
    <div class="highscore-value" id="highscore-value">0</div>
    <div class="highscore-player" id="highscore-player">-</div>
  </div>

  <div class="username-section">
    <div class="username-label">Enter Callsign</div>
    <input type="text" class="username-input" id="username-input" placeholder="PILOT" maxlength="12" />
  </div>

  <div class="button-container">
    <button class="start-button" id="start-btn">â¬¢ DEPLOY</button>
  </div>
  
  <button class="shop-button" onclick="openShop()">ð° SHIP SHOP</button>
  <button class="wheel-button" onclick="openWheel()">ð¡ LUCKY WHEEL</button>
  
  <button class="box-button" onclick="openBoxShop()">ð LOOT BOXES</button>

  <div class="feature-badges">
    <div class="badge">ð®  Edition</div>
    <div class="badge">ð¥ Scaling Bosses</div>
    <div class="badge green">ð Health Powerups</div>
  </div>

  <div class="instruction-text">Boss every 1000 points!<br>Full heal on boss spawn/defeat!<br>Bosses get stronger each time!<br><br>ð READY FOR BATTLE!</div>
</div>

<div id="game-container"></div>

<div class="boss-warning" id="boss-warning">â  BOSS INCOMING â </div>

<div class="hud" id="hud">
  <div class="glass-card score-card">
    <div class="stat-group">
      <div class="score-label">â SCORE</div>
      <div class="score-value" id="score-text">0</div>
    </div>
  </div>

  <div class="glass-card health-card">
    <div class="health-label">â LIVES</div>
    <div class="hearts" id="hearts-container">
      <div class="heart">â¬¢</div>
      <div class="heart">â¬¢</div>
      <div class="heart">â¬¢</div>
    </div>
  </div>

  <div class="glass-card wave-badge" id="money-display">
    <span style="color: var(--ubi-yellow);">ð° </span><span id="money-amount">0</span>
  </div>
  <div class="glass-card wave-badge" id="wave-text">WAVE 1</div>
</div>

<div class="boss-health-container" id="boss-health-container">
  <div class="boss-label" id="boss-label-text">â  BOSS SHIP â </div>
  <div class="boss-health-bar-bg">
    <div class="boss-health-bar">
      <div class="boss-health-fill" id="boss-health-fill" style="width: 100%"></div>
    </div>
  </div>
</div>

<div class="difficulty-indicator" id="difficulty-indicator">
  <div class="difficulty-label">â  THREAT LEVEL</div>
  <div class="difficulty-bar">
    <div class="difficulty-fill" id="difficulty-fill" style="width: 10%"></div>
  </div>
</div>

<div class="modal" id="game-over-modal">
  <div class="modal-content">
    <h1 class="modal-title">â  MISSION FAILED</h1>
    <div class="new-record-badge" id="new-record-badge">ð NEW HIGH SCORE! ð</div>
    <div class="modal-score" id="modal-score">0</div>
    <div class="modal-stats">
      <div class="modal-stat">
        <div class="modal-stat-label">Wave Reached</div>
        <div class="modal-stat-value" id="modal-wave">1</div>
      </div>
      <div class="modal-stat">
        <div class="modal-stat-label">Total Kills</div>
        <div class="modal-stat-value" id="modal-kills">0</div>
      </div>
      <div class="modal-stat">
        <div class="modal-stat-label">Bosses Defeated</div>
        <div class="modal-stat-value" id="modal-bosses">0</div>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="modal-button" onclick="location.reload()">â¬¢ REDEPLOY</button>
    </div>
  </div>
</div>

<script>
let gameStarted = false;
let phaserGame;
let playerUsername = "";
let playerMoney=0;let ownedShips=["default"];let equippedShip="default";let passLevel=1;let passXP=0;
let quests={kill50:{id:"kill50",name:"Destroy 50 Enemies",type:"kill",target:50,current:0,reward:50,complete:false},shoot200:{id:"shoot200",name:"Fire 200 Shots",type:"shoot",target:200,current:0,reward:30,complete:false},wave10:{id:"wave10",name:"Reach Wave 10",type:"wave",target:10,current:0,reward:75,complete:false},boss3:{id:"boss3",name:"Defeat 3 Bosses",type:"boss",target:3,current:0,reward:100,complete:false}};
    const SHIPS = {
      'default': { name: 'STANDARD', icon: 'ð·', price: 0, ability: 'BALANCED STATS', fireRate: 200, bulletSpeed: 650, moneyMultiplier: 1, trait: 'none', bulletColor: 0xFFD700 },
      'rapid': { name: 'RAPID FIRE', icon: 'â¡', price: 2000, ability: 'SHOOTS 2X FASTER', fireRate: 100, bulletSpeed: 700, moneyMultiplier: 1, trait: 'none', bulletColor: 0x0099FF },
      'shield': { name: 'SHIELD MASTER', icon: 'ð¡ï¸', price: 3000, ability: '+2 EXTRA LIVES', fireRate: 200, bulletSpeed: 650, moneyMultiplier: 1, trait: 'shield', bulletColor: 0x00FF66 },
      'missile': { name: 'MISSILE PRO', icon: 'ð', price: 3500, ability: 'MISSILES DO 2X DAMAGE', fireRate: 220, bulletSpeed: 850, moneyMultiplier: 1, trait: 'explosive', bulletColor: 0xFF6600 },
      'speed': { name: 'SPEED DEMON', icon: 'ð¨', price: 4000, ability: 'MOVES 50% FASTER', fireRate: 150, bulletSpeed: 900, moneyMultiplier: 1, trait: 'none', bulletColor: 0x00FFFF },
      'plasma': { name: 'PLASMA CANNON', icon: 'âï¸', price: 5000, ability: 'PLASMA SHOTS PIERCE', fireRate: 180, bulletSpeed: 800, moneyMultiplier: 1, trait: 'none', bulletColor: 0x9D4EDD },
      'ghost': { name: 'GHOST SHIP', icon: 'ð»', price: 6000, ability: 'INVISIBILITY COOLDOWN -30%', fireRate: 170, bulletSpeed: 750, moneyMultiplier: 1, trait: 'none', bulletColor: 0xAAAAAA },
      'tank': { name: 'HEAVY TANK', icon: 'ð°', price: 6500, ability: '+3 LIVES BUT SLOWER', fireRate: 250, bulletSpeed: 600, moneyMultiplier: 1, trait: 'shield', bulletColor: 0x808080 },
      'sniper': { name: 'SNIPER', icon: 'ð¯', price: 7000, ability: 'SHOTS DO 3X DAMAGE', fireRate: 320, bulletSpeed: 1300, moneyMultiplier: 1, trait: 'none', bulletColor: 0xFF0033 },
      'phoenix': { name: 'PHOENIX', icon: 'ð¥', price: 8000, ability: 'REVIVE ONCE PER GAME', fireRate: 180, bulletSpeed: 800, moneyMultiplier: 2, trait: 'none', bulletColor: 0xFF4500 },
      'frost': { name: 'FROST BLADE', icon: 'âï¸', price: 8500, ability: 'SLOWS ASTEROIDS 40%', fireRate: 200, bulletSpeed: 700, moneyMultiplier: 1, trait: 'none', bulletColor: 0x00FFFF },
      'thunder': { name: 'THUNDER BOLT', icon: 'â¡', price: 9000, ability: 'CHAIN LIGHTNING SHOTS', fireRate: 160, bulletSpeed: 950, moneyMultiplier: 2, trait: 'none', bulletColor: 0xFFFF00 },
      'vampire': { name: 'VAMPIRE', icon: 'ð¦', price: 10000, ability: 'STEAL LIFE FROM KILLS', fireRate: 190, bulletSpeed: 850, moneyMultiplier: 2, trait: 'none', bulletColor: 0xFF0033 },
      'dragon': { name: 'DRAGON FURY', icon: 'ð', price: 12000, ability: 'FLAME BREATH ATTACK', fireRate: 350, bulletSpeed: 700, moneyMultiplier: 4, trait: 'explosive', bulletColor: 0xFF0033 },
      'ninja': { name: 'SHADOW NINJA', icon: 'ð¥·', price: 13000, ability: 'TRIPLE SHOT + STEALTH', fireRate: 110, bulletSpeed: 1100, moneyMultiplier: 2, trait: 'none', bulletColor: 0x000000 },
      'mech': { name: 'MEGA MECH', icon: 'ð¤', price: 15000, ability: 'LASER BARRAGE MODE', fireRate: 75, bulletSpeed: 1250, moneyMultiplier: 2, trait: 'none', bulletColor: 0xFF0000 },
      'angel': { name: 'ANGEL WINGS', icon: 'ð', price: 17000, ability: 'HEALING AURA', fireRate: 140, bulletSpeed: 1050, moneyMultiplier: 2, trait: 'shield', bulletColor: 0xFFFFFF },
      'demon': { name: 'DEMON LORD', icon: 'ð', price: 20000, ability: 'DARK ENERGY BLAST', fireRate: 120, bulletSpeed: 1100, moneyMultiplier: 3, trait: 'double', bulletColor: 0xFF0000 },
      'alien': { name: 'ALIEN TECH', icon: 'ð½', price: 25000, ability: 'TELEPORT ANYWHERE', fireRate: 85, bulletSpeed: 1300, moneyMultiplier: 3, trait: 'none', bulletColor: 0x00FF00 },
      'cosmic': { name: 'COSMIC TITAN', icon: 'ð', price: 30000, ability: 'BLACK HOLE WEAPON', fireRate: 280, bulletSpeed: 950, moneyMultiplier: 4, trait: 'explosive', bulletColor: 0x9D4EDD },
      'rainbow': { name: 'RAINBOW BURST', icon: 'ð', price: 35000, ability: 'RAINBOW LASER BEAM', fireRate: 140, bulletSpeed: 1100, moneyMultiplier: 3, trait: 'double', bulletColor: 0xFFFF00 },
      'golden': { name: 'GOLDEN GOD', icon: 'ð', price: 50000, ability: '2X COINS + INVINCIBLE', fireRate: 180, bulletSpeed: 800, moneyMultiplier: 5, trait: 'double', bulletColor: 0xFFD700 },
      'ultimate': { name: 'ULTIMATE OMEGA', icon: 'ð«', price: 100000, ability: 'ALL ABILITIES COMBINED', fireRate: 70, bulletSpeed: 1400, moneyMultiplier: 5, trait: 'double', bulletColor: 0xFF6600 }
    };
const PASS_REWARDS=[{level:1,icon:"ð°",name:"500 CREDITS",type:"credits",value:500},{level:2,icon:"ð°",name:"750 CREDITS",type:"credits",value:750},{level:3,icon:"ð°",name:"1000 CREDITS",type:"credits",value:1000},{level:4,icon:"ð°",name:"1500 CREDITS",type:"credits",value:1500},{level:5,icon:"ð°",name:"2000 CREDITS",type:"credits",value:2000},{level:6,icon:"ð°",name:"2500 CREDITS",type:"credits",value:2500},{level:7,icon:"ð°",name:"3000 CREDITS",type:"credits",value:3000},{level:8,icon:"ð°",name:"4000 CREDITS",type:"credits",value:4000},{level:9,icon:"ð°",name:"5000 CREDITS",type:"credits",value:5000},{level:10,icon:"ð",name:"CHROMA PHANTOM",type:"ship",value:"chroma"}];

function loadPlayerData(){const m=localStorage.getItem("asteroidMoney");const o=localStorage.getItem("asteroidOwnedShips");const e=localStorage.getItem("asteroidEquippedShip");const pl=localStorage.getItem("asteroidPassLevel");const px=localStorage.getItem("asteroidPassXP");const q=localStorage.getItem("asteroidQuests");if(m)playerMoney=parseInt(m);if(o)ownedShips=JSON.parse(o);if(e)equippedShip=e;if(pl)passLevel=parseInt(pl);if(px)passXP=parseInt(px);if(q)quests=JSON.parse(q);updateMoneyDisplay();}
function savePlayerData(){localStorage.setItem("asteroidMoney",playerMoney.toString());localStorage.setItem("asteroidOwnedShips",JSON.stringify(ownedShips));localStorage.setItem("asteroidEquippedShip",equippedShip);localStorage.setItem("asteroidPassLevel",passLevel.toString());localStorage.setItem("asteroidPassXP",passXP.toString());localStorage.setItem("asteroidQuests",JSON.stringify(quests));}
function addMoney(amt){const shipStats=getEquippedShipStats();const mult=shipStats.moneyMultiplier||1;playerMoney+=Math.floor(amt*mult);savePlayerData();updateMoneyDisplay();}
function updateMoneyDisplay(){const elem=document.getElementById("money-amount");if(elem)elem.textContent=playerMoney;}
function showErrorMessage(){const toast=document.getElementById("error-toast");toast.classList.add("active");playHit();setTimeout(()=>{toast.classList.remove("active")},2000);}
function showQuestComplete(reward){const toast=document.getElementById("quest-toast");document.getElementById("quest-reward-text").textContent="+"+reward+" XP";toast.classList.add("active");setTimeout(()=>{toast.classList.remove("active")},2500);}
function showLevelUp(level){const toast=document.getElementById("levelup-toast");document.getElementById("levelup-num").textContent=level;toast.classList.add("active");setTimeout(()=>{toast.classList.remove("active")},3000);}
function updateQuest(type,amount){let anyComplete=false;Object.keys(quests).forEach(key=>{const q=quests[key];if(q.type===type&&!q.complete){q.current+=amount;if(q.current>=q.target){q.current=q.target;q.complete=true;addPassXP(q.reward);showQuestComplete(q.reward);anyComplete=true;}}});if(anyComplete)savePlayerData();}
function addPassXP(amt){passXP+=amt;const xpNeeded=passLevel*100;while(passXP>=xpNeeded&&passLevel<10){passXP-=xpNeeded;passLevel++;showLevelUp(passLevel);givePassReward(passLevel);}savePlayerData();updatePassDisplay();}
function givePassReward(level){const reward=PASS_REWARDS.find(r=>r.level===level);if(!reward)return;if(reward.type==="credits"){playerMoney+=reward.value;updateMoneyDisplay();}else if(reward.type==="ship"){if(!ownedShips.includes(reward.value)){ownedShips.push(reward.value);}}savePlayerData();}
function getEquippedShipStats(){return SHIPS[equippedShip]||SHIPS.default;}
function openShop(){document.getElementById("shop-panel").classList.add("active");document.getElementById("shop-money").textContent=playerMoney;renderShips();document.getElementById("shop-gems").textContent=playerGems;}
function closeShop(){document.getElementById("shop-panel").classList.remove("active");}
function openShipPass(){document.getElementById("pass-panel").classList.add("active");updatePassDisplay();renderQuests();renderRewards();}
function closeShipPass(){document.getElementById("pass-panel").classList.remove("active");}
function updatePassDisplay(){document.getElementById("pass-level").textContent=passLevel;document.getElementById("pass-xp").textContent=passXP;const xpNeeded=passLevel*100;document.getElementById("pass-xp-needed").textContent=xpNeeded;const percent=(passXP/xpNeeded)*100;document.getElementById("pass-bar").style.width=Math.min(percent,100)+"%";}
function renderQuests(){const grid=document.getElementById("quests-grid");grid.innerHTML="";Object.keys(quests).forEach(key=>{const q=quests[key];const card=document.createElement("div");card.className="quest-card";if(q.complete)card.classList.add("complete");card.innerHTML=`<div class="quest-info"><div class="quest-name">${q.name}</div><div class="quest-progress">${q.current} / ${q.target}</div></div><div class="quest-reward">${q.complete?"â DONE":"+"+q.reward+" XP"}</div>`;grid.appendChild(card);});}
function renderRewards(){const grid=document.getElementById("rewards-grid");grid.innerHTML="";PASS_REWARDS.forEach(reward=>{const card=document.createElement("div");card.className="reward-card";if(passLevel>=reward.level)card.classList.add("unlocked");if(reward.level===10)card.classList.add("chroma");card.innerHTML=`<div class="reward-icon">${reward.icon}</div><div class="reward-name">${reward.name}</div><div class="reward-level">LEVEL ${reward.level}</div>`;grid.appendChild(card);});}
function renderShips(){const grid=document.getElementById("ships-grid");grid.innerHTML="";Object.keys(SHIPS).forEach(key=>{const ship=SHIPS[key];if(ship.special&&!ownedShips.includes(key))return;const owned=ownedShips.includes(key);const equipped=equippedShip===key;const card=document.createElement("div");card.className="ship-card";if(owned)card.classList.add("owned");if(equipped)card.classList.add("equipped");let status="";if(equipped){status='<div class="ship-status equipped">â EQUIPPED</div>';}else if(owned){status='<div class="ship-status owned">CLICK TO EQUIP</div>';}else if(ship.price===0){status='<div class="ship-status owned">SHIP PASS REWARD</div>';}else{status='<div class="ship-price">ð° '+ship.price+"</div>";}card.innerHTML=`<div class="ship-icon">${ship.icon}</div><div class="ship-name">${ship.name}</div>${status}`;card.onclick=()=>handleShipClick(key);grid.appendChild(card);});}
function handleShipClick(key){const ship=SHIPS[key];const owned=ownedShips.includes(key);if(owned){equippedShip=key;savePlayerData();renderShips();}else{if(playerMoney>=ship.price){playerMoney-=ship.price;ownedShips.push(key);equippedShip=key;savePlayerData();document.getElementById("shop-money").textContent=playerMoney;renderShips();}else{showErrorMessage();}}}
function openAdminPanel(){document.getElementById("admin-panel").classList.add("active");}
function closeAdminPanel(){document.getElementById("admin-panel").classList.remove("active");}
function adminAddMoney(){const input=document.getElementById("admin-money-input");const amt=parseInt(input.value);if(amt&&amt>0){playerMoney+=amt;savePlayerData();updateMoneyDisplay();input.value="";closeAdminPanel();}}
loadPlayerData();


const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;

function initAudio() {
  if (!audioCtx) {
    audioCtx = new AudioContext();
  }
}

function loadHighScore() {
  const savedScore = localStorage.getItem('asteroidDefenseHighScore');
  const savedPlayer = localStorage.getItem('asteroidDefenseHighScorePlayer');

  if (savedScore) {
    document.getElementById('highscore-value').textContent = savedScore;
    document.getElementById('highscore-player').textContent = savedPlayer || 'PILOT';
  } else {
    document.getElementById('highscore-value').textContent = '0';
    document.getElementById('highscore-player').textContent = '-';
  }
}

function saveHighScore(score, player) {
  const currentHigh = parseInt(localStorage.getItem('asteroidDefenseHighScore') || '0');
  if (score > currentHigh) {
    localStorage.setItem('asteroidDefenseHighScore', score.toString());
    localStorage.setItem('asteroidDefenseHighScorePlayer', player);
    return true;
  }
  return false;
}

function playShoot() {
  if (!audioCtx) return;
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
  oscillator.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.03);

  gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.03);

  oscillator.start(audioCtx.currentTime);
  oscillator.stop(audioCtx.currentTime + 0.03);
}

function playExplosion() {
  if (!audioCtx) return;
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.type = 'sawtooth';
  oscillator.frequency.setValueAtTime(120, audioCtx.currentTime);
  oscillator.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.15);

  gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);

  oscillator.start(audioCtx.currentTime);
  oscillator.stop(audioCtx.currentTime + 0.15);
}

function playBossExplosion() {
  if (!audioCtx) return;

  for (let i = 0; i < 3; i++) {
    setTimeout(() => {
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      oscillator.type = 'sawtooth';
      oscillator.frequency.setValueAtTime(150 - i * 30, audioCtx.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + 0.25);

      gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.25);

      oscillator.start(audioCtx.currentTime);
      oscillator.stop(audioCtx.currentTime + 0.25);
    }, i * 100);
  }
}

function playHit() {
  if (!audioCtx) return;
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.type = 'square';
  oscillator.frequency.setValueAtTime(80, audioCtx.currentTime);

  gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);

  oscillator.start(audioCtx.currentTime);
  oscillator.stop(audioCtx.currentTime + 0.08);
}

function playBossWarning() {
  if (!audioCtx) return;
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.type = 'sine';
  oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
  oscillator.frequency.setValueAtTime(500, audioCtx.currentTime + 0.15);

  gainNode.gain.setValueAtTime(0.12, audioCtx.currentTime);
  gainNode.gain.setValueAtTime(0, audioCtx.currentTime + 0.3);

  oscillator.start(audioCtx.currentTime);
  oscillator.stop(audioCtx.currentTime + 0.3);
}

function playBossShoot() {
  if (!audioCtx) return;
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.type = 'square';
  oscillator.frequency.setValueAtTime(250, audioCtx.currentTime);
  oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.05);

  gainNode.gain.setValueAtTime(0.06, audioCtx.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);

  oscillator.start(audioCtx.currentTime);
  oscillator.stop(audioCtx.currentTime + 0.05);
}

function playHealthPickup() {
  if (!audioCtx) return;
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.type = 'sine';
  oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
  oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.2);

  gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);

  oscillator.start(audioCtx.currentTime);
  oscillator.stop(audioCtx.currentTime + 0.2);
}


// Level complete screen
function showLevelComplete(completedLevel) {
  const modal = document.getElementById('game-over-modal');
  const acc = shotsHit > 0 ? Math.floor((shotsHit / shotsFired) * 100) : 0;
  const isLastLevel = completedLevel >= 10;

  modal.querySelector('.modal-content').innerHTML = 
    '<div style="background:linear-gradient(135deg,#00FF66,#00CC55);padding:20px 40px;border-radius:16px 16px 0 0;margin:-32px -32px 30px -32px;"><h1 style="font-size:48px;font-weight:900;color:#000;margin:0;text-transform:uppercase;">' + (isLastLevel ? 'ð LEVEL ' + completedLevel + ' COMPLETE!' : 'â LEVEL ' + completedLevel + ' COMPLETE!') + '</h1></div>' +
    '<div style="font-size:64px;font-weight:900;background:linear-gradient(135deg,#FFD700,#FF6600);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:30px;">' + score + '</div>' +
    '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:30px;padding:20px;background:rgba(255,255,255,0.05);border-radius:12px;">' +
    '<div style="text-align:center;"><div style="font-size:40px;">ð</div><div style="font-size:11px;color:#888;">KILLS</div><div style="font-size:32px;font-weight:900;color:#FF6600;">' + kills + '</div></div>' +
    '<div style="text-align:center;"><div style="font-size:40px;">ð¯</div><div style="font-size:11px;color:#888;">ACCURACY</div><div style="font-size:32px;font-weight:900;color:#0099FF;">' + acc + '%</div></div>' +
    '<div style="text-align:center;"><div style="font-size:40px;">ð¾</div><div style="font-size:11px;color:#888;">BOSSES</div><div style="font-size:32px;font-weight:900;color:#FFD700;">' + bossesDefeated + '</div></div></div>' +
    (isLastLevel ? '<div style="font-size:20px;color:#FFD700;margin-bottom:30px;font-weight:800;">ð ALL 10 LEVELS COMPLETE! ð</div>' : '<div style="font-size:20px;color:#00FF66;margin-bottom:30px;font-weight:800;">ð NEXT LEVEL READY!</div>') +
    '<div style="display:flex;gap:16px;">' +
      (isLastLevel ? 
        '<button onclick="location.reload()" style="flex:1;padding:24px;background:linear-gradient(135deg,#FFD700,#FF6600);color:#000;border:none;border-radius:16px;font-size:20px;font-weight:900;cursor:pointer;">ð MAIN MENU</button>' :
        '<button onclick="continueNextLevel()" style="flex:1;padding:24px;background:linear-gradient(135deg,#00FF66,#00CC55);color:#000;border:none;border-radius:16px;font-size:20px;font-weight:900;cursor:pointer;">â¶ NEXT LEVEL</button>' +
        '<button onclick="location.reload()" style="flex:1;padding:24px;background:linear-gradient(135deg,#FF6600,#cc5200);color:white;border:none;border-radius:16px;font-size:20px;font-weight:900;cursor:pointer;">ð  MAIN MENU</button>'
      ) +
    '</div>';
  modal.classList.add('active');
}

function continueNextLevel() {
  currentLevel++;
  document.getElementById('game-over-modal').classList.remove('active');
  isGameOver = false;
  spawnTimer = 0;
  health = 3;
  nextBossScore = score + 1000;
  updateHeartsDisplay();
  if (gameScene) {
    asteroidsGroup.clear(true, true);
    cometsGroup.clear(true, true);
    debrisGroup.clear(true, true);
    healthPowerupsGroup.clear(true, true);
    bossBulletsGroup.clear(true, true);
  }
}

loadHighScore();

document.getElementById('start-btn').addEventListener('click', startGame);
document.getElementById('username-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    startGame();
  }
});

function startGame() {
  if (gameStarted) return;

  const usernameInput = document.getElementById('username-input').value.trim();
  playerUsername = usernameInput || 'PILOT';

  gameStarted = true;

  initAudio();

  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('game-container').classList.add('active');
  document.getElementById('hud').classList.add('active');
  document.getElementById('difficulty-indicator').classList.add('active');
  updateMoneyDisplay();
  const shipStats=getEquippedShipStats();
  fireRate=shipStats.fireRate;

  setTimeout(() => {
    initPhaserGame();
  }, 100);
}

function initPhaserGame() {
  const isMobile = window.innerWidth < 600;
  const isPortrait = window.innerHeight > window.innerWidth;

  let gameWidth, gameHeight;

  if (isMobile && isPortrait) {
    gameWidth = Math.min(window.innerWidth, 400);
    gameHeight = Math.min(window.innerHeight * 0.65, 650);
  } else {
    gameWidth = Math.min(window.innerWidth * 0.9, 800);
    gameHeight = Math.min(window.innerHeight * 0.75, 500);
  }

  const config = {
    type: Phaser.AUTO,
    width: gameWidth,
    height: gameHeight,
    backgroundColor: "transparent",
    parent: "game-container",
    scale: {
      mode: Phaser.Scale.FIT,
      autoCenter: Phaser.Scale.CENTER_BOTH
    },
    physics: {
      default: "arcade",
      arcade: {
        gravity: { y: 0 },
        debug: false
      }
    },
    scene: { preload, create, update }
  };

  phaserGame = new Phaser.Game(config);
}

let player;
let score = 0;
let health = 3;
let wave = 1;
let kills = 0;
let shotsFired = 0;
let shotsHit = 0;
let bossesDefeated = 0;
let isGameOver = false;
let spawnTimer = 0;
let spawnRate = 2000;
let fireTimer = 0;
let fireRate = 100;
let bulletsGroup, asteroidsGroup, cometsGroup, debrisGroup, bossGroup, bossBulletsGroup, healthPowerupsGroup;
let isInvulnerable = false;
let baseSpeed = 80;
let speedIncrement = 0;
let gameScene;
let lastPlayerX = 0;
let moveThreshold = 1;
let playerColliders = [];
let boss = null;
let bossActive = false;
let lastBossScore = 0;
let nextBossScore = 1000;
let particlesGroup;
let bossShootTimer = 0;
let healthSpawnTimer = 0;
let currentBossLevel = 1;
    let currentLevel = 1;
    let highestLevelUnlocked = 10;

function preload() {
  const g = this.add.graphics();

  g.fillStyle(0xFF6600);
  g.beginPath();
  g.moveTo(24, 0);
  g.lineTo(0, 40);
  g.lineTo(12, 36);
  g.lineTo(24, 40);
  g.lineTo(36, 36);
  g.lineTo(48, 40);
  g.closePath();
  g.fillPath();
  g.lineStyle(3, 0x0099FF, 0.8);
  g.strokePath();
  g.fillStyle(0xffffff);
  g.fillCircle(24, 20, 4);
  g.generateTexture("player", 48, 40);
  g.clear();

  g.fillStyle(0xff8c42);
  g.fillCircle(20, 20, 18);
  g.lineStyle(3, 0xFF6600);
  g.strokeCircle(20, 20, 18);
  g.fillStyle(0xd4722b);
  g.fillCircle(14, 14, 5);
  g.fillCircle(26, 18, 4);
  g.fillCircle(18, 26, 3);
  g.generateTexture("asteroid", 40, 40);
  g.clear();

  g.fillStyle(0x0099FF);
  g.fillCircle(15, 15, 12);
  g.lineStyle(4, 0x64c8ff);
  g.strokeCircle(15, 15, 12);
  g.fillStyle(0xffffff);
  g.fillCircle(15, 15, 6);
  g.generateTexture("comet", 30, 30);
  g.clear();

  g.fillStyle(0x888888);
  g.fillRect(0, 0, 25, 25);
  g.fillStyle(0x555555);
  g.fillRect(5, 5, 15, 15);
  g.fillStyle(0xaaaaaa);
  g.fillRect(2, 2, 8, 8);
  g.fillRect(15, 15, 8, 8);
  g.generateTexture("debris", 25, 25);
  g.clear();

  g.fillStyle(0x00FF66);
  g.fillCircle(18, 18, 16);
  g.lineStyle(4, 0x00CC55);
  g.strokeCircle(18, 18, 16);
  g.fillStyle(0xFFFFFF);
  g.fillCircle(18, 18, 10);
  g.fillStyle(0x00FF66);
  g.beginPath();
  g.moveTo(18, 8);
  g.lineTo(14, 18);
  g.lineTo(18, 16);
  g.lineTo(22, 18);
  g.closePath();
  g.fillPath();
  g.beginPath();
  g.moveTo(18, 28);
  g.lineTo(14, 18);
  g.lineTo(18, 20);
  g.lineTo(22, 18);
  g.closePath();
  g.fillPath();
  g.generateTexture("healthPowerup", 36, 36);
  g.clear();

  g.fillStyle(0xFF0033);
  g.fillRect(60, 0, 40, 20);
  g.fillRect(30, 20, 100, 40);
  g.fillRect(0, 60, 160, 30);
  g.fillRect(20, 90, 30, 30);
  g.fillRect(110, 90, 30, 30);

  g.fillStyle(0x0099FF);
  g.fillRect(50, 35, 15, 15);
  g.fillRect(95, 35, 15, 15);

  g.fillStyle(0xFFD700);
  g.fillRect(70, 30, 20, 25);

  g.fillStyle(0xFF6600);
  g.fillCircle(35, 105, 8);
  g.fillCircle(125, 105, 8);

  g.lineStyle(5, 0xFF6600);
  g.strokeRect(0, 20, 160, 100);
  g.generateTexture("boss", 160, 120);
  g.clear();

  g.fillStyle(0xFF6600);
  g.fillRoundedRect(0, 0, 8, 20, 4);
  g.fillStyle(0xffffff);
  g.fillRoundedRect(2, 2, 4, 16, 2);
  g.generateTexture("bullet", 8, 20);
  g.clear();

  g.fillStyle(0xFF0033);
  g.fillRoundedRect(0, 0, 10, 24, 5);
  g.fillStyle(0xFF6600);
  g.fillRoundedRect(2, 2, 6, 20, 4);
  g.generateTexture("bossBullet", 10, 24);
  g.clear();

  g.fillStyle(0xFFFFFF);
  g.fillCircle(4, 4, 4);
  g.generateTexture("particle", 8, 8);

  g.destroy();
}

function create() {
  gameScene = this;

  const centerX = this.sys.canvas.width / 2;
  const bottomY = this.sys.canvas.height - 60;

  player = this.physics.add.sprite(centerX, bottomY, "player");
  player.setCollideWorldBounds(true);
  player.setImmovable(true);

  lastPlayerX = player.x;

  
  // Initialize colliders array
  playerColliders = [];

  bulletsGroup = this.physics.add.group();
  asteroidsGroup = this.physics.add.group();
  cometsGroup = this.physics.add.group();
  debrisGroup = this.physics.add.group();
  bossGroup = this.physics.add.group();
  bossBulletsGroup = this.physics.add.group();
  particlesGroup = this.physics.add.group();
  healthPowerupsGroup = this.physics.add.group();

  this.input.on("pointermove", (pointer) => {
    if (!isGameOver && player && player.active) {
      const minX = 40;
      const maxX = this.sys.canvas.width - 40;
      player.x = Phaser.Math.Clamp(pointer.x, minX, maxX);
    }
  });

  this.input.keyboard.on("keydown-LEFT", () => {
    if (!isGameOver && player && player.active) {
      player.x = Phaser.Math.Clamp(player.x - 30, 40, this.sys.canvas.width - 40);
    }
  });

  this.input.keyboard.on("keydown-RIGHT", () => {
    if (!isGameOver && player && player.active) {
      player.x = Phaser.Math.Clamp(player.x + 30, 40, this.sys.canvas.width - 40);
    }
  });

  playerColliders.push(this.physics.add.overlap(bulletsGroup, asteroidsGroup, hitEnemy, null, this));
  playerColliders.push(this.physics.add.overlap(bulletsGroup, cometsGroup, hitComet, null, this));
  playerColliders.push(this.physics.add.overlap(bulletsGroup, debrisGroup, hitDebris, null, this));
  playerColliders.push(this.physics.add.overlap(bulletsGroup, bossGroup, hitBoss, null, this));
  playerColliders.push(this.physics.add.overlap(player, asteroidsGroup, hitPlayer, null, this));
  playerColliders.push(this.physics.add.overlap(player, cometsGroup, hitPlayer, null, this));
  playerColliders.push(this.physics.add.overlap(player, debrisGroup, hitPlayer, null, this));
  playerColliders.push(this.physics.add.overlap(player, bossGroup, hitPlayer, null, this));
  playerColliders.push(this.physics.add.overlap(player, bossBulletsGroup, hitPlayerByBossBullet, null, this));
  playerColliders.push(this.physics.add.overlap(player, healthPowerupsGroup, collectHealth, null, this));

  spawnWave.call(this);
}

function restoreFullHealth() {
  health = 3;
  const hearts = document.querySelectorAll(".heart");
  hearts.forEach(heart => heart.classList.remove("lost"));
}

function updateHeartsDisplay() {
  const hearts = document.querySelectorAll(".heart");
  hearts.forEach((heart, index) => {
    if (index >= health) {
      heart.classList.add("lost");
    } else {
      heart.classList.remove("lost");
    }
  });
}

function collectHealth(playerObj, healthPowerup) {
  if (!healthPowerup || !healthPowerup.active) return;

  const hx = healthPowerup.x;
  const hy = healthPowerup.y;

  healthPowerup.destroy();

  createExplosion(hx, hy, 0x00FF66, 12);
  playHealthPickup();

  if (health < 3) {
    health++;
    updateHeartsDisplay();
  }
}

function spawnHealthPowerup() {
  if (!gameScene || isGameOver || bossActive) return;

  const x = Phaser.Math.Between(80, gameScene.sys.canvas.width - 80);
  const healthPowerup = healthPowerupsGroup.create(x, -20, "healthPowerup");
  if (!healthPowerup) return;

  healthPowerup.body.setVelocityY(120);
  healthPowerup.setCircle(16, 2, 2);
  healthPowerup.setScale(0.5);

  gameScene.tweens.add({ 
    targets: healthPowerup, 
    scale: 1, 
    duration: 400, 
    ease: 'Back.easeOut' 
  });

  gameScene.tweens.add({ 
    targets: healthPowerup, 
    alpha: { from: 1, to: 0.7 }, 
    duration: 400, 
    yoyo: true, 
    repeat: -1 
  });

  gameScene.tweens.add({ 
    targets: healthPowerup, 
    angle: 360, 
    duration: 2000, 
    repeat: -1 
  });
}

function createExplosion(x, y, color = 0xFF6600, particleCount = 12) {
  if (!gameScene) return;

  for (let i = 0; i < particleCount; i++) {
    const particle = particlesGroup.create(x, y, "particle");
    if (!particle) continue;

    particle.setTint(color);
    particle.setAlpha(1);

    const angle = (i / particleCount) * Math.PI * 2;
    const speed = 100 + Math.random() * 150;

    particle.body.setVelocity(
      Math.cos(angle) * speed,
      Math.sin(angle) * speed
    );

    gameScene.tweens.add({
      targets: particle,
      alpha: 0,
      scale: 0,
      duration: 500 + Math.random() * 300,
      ease: 'Power2',
      onComplete: () => {
        if (particle && particle.active) particle.destroy();
      }
    });
  }
}

function createBossExplosion(x, y) {
  if (!gameScene) return;

  for (let wave = 0; wave < 4; wave++) {
    gameScene.time.delayedCall(wave * 150, () => {
      const offsetX = (Math.random() - 0.5) * 80;
      const offsetY = (Math.random() - 0.5) * 80;
      createExplosion(x + offsetX, y + offsetY, Phaser.Math.RND.pick([0xFF6600, 0xFF0033, 0xFFD700, 0x0099FF]), 20);
    });
  }

  gameScene.cameras.main.shake(500, 0.01);
}

function update(time, delta) {
  if (isGameOver) return;
  if (!player || !player.active) return;

  lastPlayerX = player.x;

  speedIncrement = wave < 16 ? Math.floor(wave / 3) * 15 : Math.floor(15 + ((wave - 15) * 3));
  spawnRate = Math.max(2000 - Math.floor(wave / 2) * 150, 800);

  fireTimer += delta;
  if (fireTimer >= fireRate) {
    fireTimer = 0;
    shoot.call(this);
  }

  if (!bossActive && score >= nextBossScore) {
    spawnBoss.call(this);
  }

  if (!bossActive) {
    spawnTimer += delta;
    if (spawnTimer >= spawnRate) {
      spawnTimer = 0;

      // Burst spawning for wave 16+
      let burstCount = wave >= 16 ? Math.min(6 + Math.floor((wave - 15) / 2), 15) : (wave >= 10 ? 2 : 1);

      for (let i = 0; i < burstCount; i++) {
        setTimeout(() => {
          if (!isGameOver && !bossActive) spawnRandomEnemy.call(this);
        }, i * 40);
      }
    }

    healthSpawnTimer += delta;
    if (healthSpawnTimer >= 15000) {
      healthSpawnTimer = 0;
      if (Math.random() < 0.3) {
        spawnHealthPowerup();
      }
    }
  }

  if (boss && boss.active && bossActive) {
    bossShootTimer += delta;
    const fireRate = boss.getData('fireRate') || 800;
    if (bossShootTimer >= fireRate) {
      bossShootTimer = 0;
      bossShoot();
    }
  }

  [asteroidsGroup, cometsGroup, debrisGroup].forEach(group => {
    group.children.entries.forEach(obj => {
      if (!obj || !obj.active) return;

      if (obj.y > this.sys.canvas.height + 30) {
        obj.destroy();
        return;
      }

      if (obj.getData('swerveTime') !== undefined) {
        const swerveTime = obj.getData('swerveTime') + delta;
        obj.setData('swerveTime', swerveTime);

        const swerveSpeed = obj.getData('swerveSpeed');
        const swervePattern = obj.getData('swervePattern');

        if (swervePattern === 'sine') {
          const swerveX = Math.sin(swerveTime / 300) * swerveSpeed;
          obj.body.setVelocityX(swerveX);
        } else if (swervePattern === 'zigzag') {
          const direction = Math.floor(swerveTime / 400) % 2 === 0 ? 1 : -1;
          obj.body.setVelocityX(direction * swerveSpeed);
        } else if (swervePattern === 'chase' && player && player.active) {
          const dirToPlayer = player.x - obj.x;
          obj.body.setVelocityX(Math.sign(dirToPlayer) * swerveSpeed * (wave < 16 ? 0.7 : 1.3));
        }
      }
    });
  });

  healthPowerupsGroup.children.entries.forEach(hp => {
    if (hp && hp.active && hp.y > this.sys.canvas.height + 30) {
      hp.destroy();
    }
  });

  if (boss && boss.active) {
    const bossTime = boss.getData('moveTime') + delta;
    boss.setData('moveTime', bossTime);

    const moveSpeed = boss.getData('moveSpeed') || 120;
    const moveX = Math.sin(bossTime / 800) * moveSpeed;
    boss.body.setVelocityX(moveX);

    if (boss.y < 100) {
      boss.body.setVelocityY(20);
    } else {
      boss.body.setVelocityY(0);
    }
  }

  bulletsGroup.children.entries.forEach(bullet => {
    if (bullet && bullet.active && bullet.y < -30) {
      bullet.destroy();
    }
  });

  bossBulletsGroup.children.entries.forEach(bullet => {
    if (bullet && bullet.active && bullet.y > this.sys.canvas.height + 30) {
      bullet.destroy();
    }
  });

  const totalEnemies = asteroidsGroup.countActive(true) + 
                      cometsGroup.countActive(true) + 
                      debrisGroup.countActive(true);

  if (!bossActive && totalEnemies === 0 && spawnTimer > 800) {
    nextWave.call(this);
  }

  document.getElementById("score-text").textContent = score;
  document.getElementById("wave-text").textContent = "WAVE " + wave;

  const difficultyPercent = Math.min((wave / 15) * 100, 100);
  document.getElementById("difficulty-fill").style.width = difficultyPercent + "%";
}

function bossShoot() {
  if (!boss || !boss.active || !player || !player.active) return;

  playBossShoot();

  const bulletCount = boss.getData('bulletCount') || 3;
  const spreadAngle = boss.getData('spreadAngle') || 15;

  const angles = [];
  if (bulletCount === 1) {
    angles.push(0);
  } else {
    for (let i = 0; i < bulletCount; i++) {
      const offset = (i - (bulletCount - 1) / 2) * spreadAngle;
      angles.push(offset);
    }
  }

  angles.forEach(angleOffset => {
    const bullet = bossBulletsGroup.create(boss.x, boss.y + 60, "bossBullet");
    if (!bullet) return;

    const angleToPlayer = Phaser.Math.Angle.Between(boss.x, boss.y, player.x, player.y);
    const finalAngle = angleToPlayer + (angleOffset * Math.PI / 180);

    const speed = boss.getData('bulletSpeed') || 300;
    bullet.body.setVelocity(
      Math.cos(finalAngle) * speed,
      Math.sin(finalAngle) * speed
    );

    bullet.setRotation(finalAngle + Math.PI / 2);
  });
}

function spawnBoss() {
  if (!gameScene || isGameOver || bossActive) return;

  asteroidsGroup.clear(true, true);
  cometsGroup.clear(true, true);
  debrisGroup.clear(true, true);
  healthPowerupsGroup.clear(true, true);

  restoreFullHealth();

  bossActive = true;
  bossShootTimer = 0;

  playBossWarning();

  const warning = document.getElementById('boss-warning');
  warning.classList.add('active');
  setTimeout(() => {
    warning.classList.remove('active');
  }, 2000);

  gameScene.time.delayedCall(2000, () => {
    if (isGameOver) return;

    const centerX = gameScene.sys.canvas.width / 2;
    boss = bossGroup.create(centerX, -60, "boss");
    if (!boss) return;

    boss.setScale(0.6);
    boss.body.setSize(140, 100);

    const baseHP = 30;
    const hpIncrease = (currentBossLevel - 1) * 25;
    const bossHP = baseHP + hpIncrease;

    boss.setData('hp', bossHP);
    boss.setData('maxHp', bossHP);
    boss.setData('moveTime', 0);
    boss.setData('level', currentBossLevel);

    if (currentBossLevel === 1) {
      boss.setData('fireRate', 1200);
      boss.setData('bulletCount', 1);
      boss.setData('spreadAngle', 0);
      boss.setData('bulletSpeed', 250);
      boss.setData('moveSpeed', 100);
    } else if (currentBossLevel === 2) {
      boss.setData('fireRate', 1000);
      boss.setData('bulletCount', 3);
      boss.setData('spreadAngle', 12);
      boss.setData('bulletSpeed', 280);
      boss.setData('moveSpeed', 120);
    } else if (currentBossLevel === 3) {
      boss.setData('fireRate', 850);
      boss.setData('bulletCount', 3);
      boss.setData('spreadAngle', 15);
      boss.setData('bulletSpeed', 300);
      boss.setData('moveSpeed', 130);
    } else if (currentBossLevel === 4) {
      boss.setData('fireRate', 700);
      boss.setData('bulletCount', 5);
      boss.setData('spreadAngle', 12);
      boss.setData('bulletSpeed', 320);
      boss.setData('moveSpeed', 140);
    } else {
      boss.setData('fireRate', Math.max(500, 700 - (currentBossLevel - 4) * 30));
      boss.setData('bulletCount', 5);
      boss.setData('spreadAngle', Math.min(18, 12 + (currentBossLevel - 4) * 1));
      boss.setData('bulletSpeed', Math.min(380, 320 + (currentBossLevel - 4) * 10));
      boss.setData('moveSpeed', Math.min(160, 140 + (currentBossLevel - 4) * 4));
    }

    let levelLabel = '';
    if (currentBossLevel === 1) {
      levelLabel = 'â  BOSS SHIP LV1 â ';
    } else if (currentBossLevel === 2) {
      levelLabel = 'â  BOSS SHIP LV2 â ';
    } else if (currentBossLevel === 3) {
      levelLabel = 'â  BOSS SHIP LV3 â ';
    } else if (currentBossLevel === 4) {
      levelLabel = 'â  BOSS SHIP LV4 â ';
    } else {
      levelLabel = 'â  BOSS SHIP LV' + currentBossLevel + ' â ';
    }
    document.getElementById('boss-label-text').textContent = levelLabel;

    document.getElementById('boss-health-container').classList.add('active');
    updateBossHealth();

    gameScene.tweens.add({
      targets: boss,
      scale: 0.8,
      duration: 500,
      ease: 'Back.easeOut'
    });
  });
}

function updateBossHealth() {
  if (!boss || !boss.active) return;
  const hp = boss.getData('hp');
  const maxHp = boss.getData('maxHp');
  const percent = (hp / maxHp) * 100;
  document.getElementById('boss-health-fill').style.width = percent + '%';
}

function hitBoss(bullet, bossObj) {
  if (isGameOver || !bullet || !bossObj || !bullet.active || !bossObj.active) return;

  bullet.destroy();
  shotsHit++;
  playHit();

  const hp = bossObj.getData('hp') || 1;

  if (hp <= 1) {
    const bx = bossObj.x;
    const by = bossObj.y;

    createBossExplosion(bx, by);
    playBossExplosion();

    bossBulletsGroup.clear(true, true);

    bossObj.destroy();
    boss = null;
    bossActive = false;
    bossesDefeated++;
    currentBossLevel++;
    score += 100;
    nextBossScore = score + 1000;

    restoreFullHealth();
    document.getElementById('boss-health-container').classList.remove('active');

    isGameOver = true;
    const completedLevel = currentLevel;
    saveHighScore(score, playerUsername);
    setTimeout(() => showLevelComplete(completedLevel), 500);

  } else {
    bossObj.setData('hp', hp - 1);
    updateBossHealth();
    bossObj.setTint(0xffffff);
    gameScene.time.delayedCall(50, () => {
      if (bossObj && bossObj.active) bossObj.clearTint();
    });
    score += 2;
  }
}

function hitPlayerByBossBullet(playerObj, bullet) {
  if (isGameOver || isInvulnerable || !bullet || !bullet.active || !playerObj || !playerObj.active) {
    return;
  }

  bullet.destroy();
  health--;
  playHit();

  updateHeartsDisplay();

  isInvulnerable = true;
  let flashCount = 0;
  const flashInterval = setInterval(() => {
    if (isGameOver) {
      clearInterval(flashInterval);
      return;
    }
    if (player && player.active) {
      player.alpha = player.alpha === 1 ? 0.3 : 1;
    }
    flashCount++;
    if (flashCount >= 10) {
      clearInterval(flashInterval);
      if (player && player.active && !isGameOver) player.alpha = 1;
      isInvulnerable = false;
    }
  }, 80);

  if (health <= 0) {
    isGameOver = true;
    clearInterval(flashInterval);

    playerColliders.forEach(collider => collider.active = false);

    if (player && player.active) {
      createExplosion(player.x, player.y, 0xFF0033, 15);
      player.setTint(0xFF6600);
      player.alpha = 1;
    }

    gameScene.time.delayedCall(500, endGame);
  }
}

function spawnRandomEnemy() {
  if (isGameOver || bossActive) return;

  if (wave <= 3) {
    spawnAsteroid.call(gameScene);
  } else if (wave <= 7) {
    const rand = Math.random();
    if (rand < 0.7) {
      spawnAsteroid.call(gameScene);
    } else {
      spawnComet.call(gameScene);
    }
  } else {
    const rand = Math.random();
    if (rand < 0.5) {
      spawnAsteroid.call(gameScene);
    } else if (rand < 0.8) {
      spawnComet.call(gameScene);
    } else {
      spawnDebris.call(gameScene);
    }
  }
}

function spawnAsteroid() {
  if (!gameScene || isGameOver) return;

  const x = Phaser.Math.Between(60, gameScene.sys.canvas.width - 60);
  const ast = asteroidsGroup.create(x, -20, "asteroid");
  if (!ast) return;

  const fallSpeed = baseSpeed + speedIncrement + wave * 8;
  ast.body.setVelocityY(fallSpeed);
  ast.setCircle(18, 2, 2);
  ast.setScale(0.5);

  const patterns = ['sine', 'zigzag', 'chase', 'straight'];
  ast.setData('swervePattern', Phaser.Math.RND.pick(patterns));
  ast.setData('swerveSpeed', Phaser.Math.Between(100 + (wave * 6), 200 + (wave * 10)));
  ast.setData('swerveTime', 0);

  gameScene.tweens.add({ targets: ast, scale: 1, duration: 300, ease: 'Back.easeOut' });
  gameScene.tweens.add({ targets: ast, angle: 360, duration: 2000, repeat: -1 });
}

function spawnComet() {
  if (!gameScene || isGameOver) return;

  const x = Phaser.Math.Between(60, gameScene.sys.canvas.width - 60);
  const comet = cometsGroup.create(x, -20, "comet");
  if (!comet) return;

  const fallSpeed = baseSpeed + speedIncrement + wave * 12 + 30;
  comet.body.setVelocityY(fallSpeed);
  comet.setCircle(12, 3, 3);
  comet.setScale(0.5);
  comet.setData('swervePattern', 'chase');
  comet.setData('swerveSpeed', Phaser.Math.Between(100, 160));
  comet.setData('swerveTime', 0);
  comet.setData('hp', 2);

  gameScene.tweens.add({ targets: comet, scale: 1.2, duration: 300, ease: 'Back.easeOut' });
  gameScene.tweens.add({ targets: comet, alpha: { from: 1, to: 0.6 }, duration: 300, yoyo: true, repeat: -1 });
}

function spawnDebris() {
  if (!gameScene || isGameOver) return;

  const x = Phaser.Math.Between(60, gameScene.sys.canvas.width - 60);
  const debris = debrisGroup.create(x, -20, "debris");
  if (!debris) return;

  const fallSpeed = baseSpeed + speedIncrement + wave * 10;
  debris.body.setVelocityY(fallSpeed);
  debris.setCircle(12, 1, 1);
  debris.setScale(0.5);
  debris.setData('swervePattern', 'zigzag');
  debris.setData('swerveSpeed', Phaser.Math.Between(50, 100));
  debris.setData('swerveTime', 0);

  gameScene.tweens.add({ targets: debris, scale: 0.9, duration: 300, ease: 'Back.easeOut' });
  gameScene.tweens.add({ targets: debris, angle: 180, duration: 1500, repeat: -1 });
}

function spawnWave() {
  if (!gameScene || isGameOver) return;

  asteroidsGroup.clear(true, true);
  cometsGroup.clear(true, true);
  debrisGroup.clear(true, true);
  spawnTimer = 0;

  let asteroidCount, cometCount, debrisCount;

  if (wave <= 3) {
    asteroidCount = Math.min(3 + wave, 8);
    cometCount = 0;
    debrisCount = 0;
  } else if (wave <= 7) {
    asteroidCount = Math.min(4 + wave, 10);
    cometCount = Math.min(wave - 3, 4);
    debrisCount = 0;
  } else {
    asteroidCount = Math.min(5 + wave, 12);
    cometCount = Math.min(Math.floor(wave / 2), 6);
    debrisCount = Math.min(Math.floor(wave / 3), 5);
  }

  for (let i = 0; i < asteroidCount; i++) {
    gameScene.time.delayedCall(i * 400, () => { if (!isGameOver && !bossActive) spawnAsteroid.call(gameScene); });
  }

  for (let i = 0; i < cometCount; i++) {
    gameScene.time.delayedCall((asteroidCount + i) * 400, () => { if (!isGameOver && !bossActive) spawnComet.call(gameScene); });
  }

  for (let i = 0; i < debrisCount; i++) {
    gameScene.time.delayedCall((asteroidCount + cometCount + i) * 400, () => { if (!isGameOver && !bossActive) spawnDebris.call(gameScene); });
  }
}

function shoot() {
  if (isGameOver || !player || !player.active) return;
  shotsFired++;
  playShoot();

  const bullet = bulletsGroup.create(player.x, player.y - 20, "bullet");
  if (!bullet) return;

  bullet.body.setVelocityY(-650);
  bullet.setCircle(4, 0, 8);
}

function hitEnemy(bullet, enemy) {
  if (isGameOver || !bullet || !enemy || !bullet.active || !enemy.active) return;

  const ex = enemy.x;
  const ey = enemy.y;

  bullet.destroy();
  enemy.destroy();

  createExplosion(ex, ey, 0xFF6600, 8);
  playExplosion();

  shotsHit++;
  kills++;
  score += 5;
  addMoney(10);
  updateQuest('kill',1);
}

function hitComet(bullet, comet) {
  if (isGameOver || !bullet || !comet || !bullet.active || !comet.active) return;

  bullet.destroy();

  const hp = comet.getData('hp') || 1;
  if (hp <= 1) {
    const cx = comet.x;
    const cy = comet.y;

    comet.destroy();
    createExplosion(cx, cy, 0x0099FF, 10);
    playExplosion();

    shotsHit++;
    kills++;
    score += 15;
    addMoney(20);
    updateQuest('kill',1);
  } else {
    comet.setData('hp', hp - 1);
    comet.setTint(0xff6666);
    playHit();
    gameScene.time.delayedCall(100, () => {
      if (comet && comet.active) comet.clearTint();
    });
    shotsHit++;
    score += 3;
  }
}

function hitDebris(bullet, debris) {
  if (isGameOver || !bullet || !debris || !bullet.active || !debris.active) return;

  const dx = debris.x;
  const dy = debris.y;

  bullet.destroy();
  debris.destroy();

  createExplosion(dx, dy, 0x888888, 6);
  playExplosion();

  shotsHit++;
  kills++;
  score += 3;
  addMoney(5);
  updateQuest('kill',1);
}

function hitPlayer(playerObj, enemy) {
  if (isGameOver || isInvulnerable || !enemy || !enemy.active || !playerObj || !playerObj.active) {
    return;
  }

  enemy.destroy();
  health--;
  playHit();

  updateHeartsDisplay();

  isInvulnerable = true;
  let flashCount = 0;
  const flashInterval = setInterval(() => {
    if (isGameOver) {
      clearInterval(flashInterval);
      return;
    }
    if (player && player.active) {
      player.alpha = player.alpha === 1 ? 0.3 : 1;
    }
    flashCount++;
    if (flashCount >= 10) {
      clearInterval(flashInterval);
      if (player && player.active && !isGameOver) player.alpha = 1;
      isInvulnerable = false;
    }
  }, 80);

  if (health <= 0) {
    isGameOver = true;
    clearInterval(flashInterval);

    playerColliders.forEach(collider => collider.active = false);

    if (player && player.active) {
      createExplosion(player.x, player.y, 0xFF0033, 15);
      player.setTint(0xFF6600);
      player.alpha = 1;
    }

    gameScene.time.delayedCall(500, endGame);
  }
}

function nextWave() {
  if (isGameOver) return;
  wave++;
  spawnWave.call(gameScene);
}

function endGame() {
  console.log("ð endGame() called");

  if (window.endGameRunning) {
    console.log("â ï¸ endGame already running");
    return;
  }
  window.endGameRunning = true;

  isGameOver = true;

  // Clean up
  asteroidsGroup.clear(true, true);
  cometsGroup.clear(true, true);
  debrisGroup.clear(true, true);
  bossGroup.clear(true, true);
  bulletsGroup.clear(true, true);
  bossBulletsGroup.clear(true, true);
  healthPowerupsGroup.clear(true, true);

  // Pause scene
  if (gameScene && gameScene.scene) {
    gameScene.scene.pause();
    console.log("â¸ï¸ Scene paused");
  }

  // Destroy player
  if (player && player.active) {
    player.destroy();
    player = null;
    console.log("ðï¸ Player destroyed");
  }

  // Hide boss UI
  document.getElementById('boss-health-container')?.classList.remove('active');
  document.getElementById('boss-warning')?.classList.remove('active');

  const isNewRecord = saveHighScore(score, playerUsername);
  console.log("ð¾ Score saved. New record:", isNewRecord);

  setTimeout(() => {
    const modal = document.getElementById("game-over-modal");
    const modalContent = modal?.querySelector('.modal-content');

    // CRITICAL: Restore original modal HTML if it was changed
    if (modalContent) {
      const currentHTML = modalContent.innerHTML;
      const isLevelComplete = currentHTML.includes('LEVEL') && currentHTML.includes('COMPLETE');

      if (isLevelComplete) {
        console.log("ð Modal shows level complete, restoring to mission failed");

        if (window.originalModalHTML) {
          modalContent.innerHTML = window.originalModalHTML;
          console.log("â Original modal HTML restored");
        } else {
          console.error("â originalModalHTML not found! Reloading page...");
          location.reload();
          return;
        }
      } else {
        console.log("â Modal already has correct structure");
      }
    }

    // Update stats
    const modalScore = document.getElementById("modal-score");
    const modalWave = document.getElementById("modal-wave");
    const modalKills = document.getElementById("modal-kills");
    const modalBosses = document.getElementById("modal-bosses");
    const recordBadge = document.getElementById("new-record-badge");

    if (modalScore) modalScore.textContent = score;
    if (modalWave) modalWave.textContent = wave;
    if (modalKills) modalKills.textContent = kills;
    if (modalBosses) modalBosses.textContent = bossesDefeated;

    if (recordBadge) {
      if (isNewRecord) {
        recordBadge.classList.add("active");
      } else {
        recordBadge.classList.remove("active");
      }
    }

    // Show modal
    if (modal) {
      modal.classList.add("active");
      modal.style.display = "flex";
      console.log("â MISSION FAILED modal shown");
    }

    window.endGameRunning = false;
  }, 200);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Save original modal HTML
  const modal = document.getElementById('game-over-modal');
  const modalContent = modal?.querySelector('.modal-content');
  if (modalContent) {
    window.originalModalHTML = modalContent.innerHTML;
    console.log('ð¾ Original modal HTML saved:', window.originalModalHTML.substring(0, 100) + '...');
  } else {
    console.error('â Could not find modal content to save!');
  }
});



// GEMS & BOX SYSTEM
let playerGems=0;
const BOXES = {
  basic: {
    name: "Basic Box",
    icon: "ð¦",
    price: 100,
    description: "Common rewards",
    tier: "basic"
  },
  premium: {
    name: "Premium Box",
    icon: "ð",
    price: 500,
    description: "Rare & Epic rewards!",
    tier: "premium"
  },
  legendary: {
    name: "Legendary Box",
    icon: "ð",
    price: 2000,
    description: "Legendary guaranteed!",
    tier: "legendary"
  },
  mythic: {
    name: "Mythic Box",
    icon: "â­",
    price: 5000,
    description: "MYTHIC LOOT ONLY!",
    tier: "mythic"
  }
};

const BOX_REWARDS = {
  common: [
    { type: "credits", amount: 50, name: "50 Credits", icon: "ð°", rarity: "common" },
    { type: "credits", amount: 100, name: "100 Credits", icon: "ð°", rarity: "common" },
    { type: "credits", amount: 150, name: "150 Credits", icon: "ðµ", rarity: "common" },
    { type: "gems", amount: 5, name: "5 Gems", icon: "ð", rarity: "common" },
    { type: "gems", amount: 10, name: "10 Gems", icon: "ð", rarity: "common" },
  ],
  rare: [
    { type: "credits", amount: 300, name: "300 Credits", icon: "ðµ", rarity: "rare" },
    { type: "credits", amount: 500, name: "500 Credits", icon: "ðµ", rarity: "rare" },
    { type: "gems", amount: 25, name: "25 Gems", icon: "ð", rarity: "rare" },
    { type: "gems", amount: 50, name: "50 Gems", icon: "ð", rarity: "rare" },
    { type: "ship", ship: "rapid", name: "Plasma Blaster", icon: "â¡", rarity: "rare" },
    { type: "ship", ship: "sniper", name: "Rail Cannon", icon: "ð¯", rarity: "rare" },
  ],
  epic: [
    { type: "credits", amount: 1000, name: "1000 Credits", icon: "ð¸", rarity: "epic" },
    { type: "credits", amount: 1500, name: "1500 Credits", icon: "ð¸", rarity: "epic" },
    { type: "gems", amount: 100, name: "100 Gems", icon: "ð", rarity: "epic" },
    { type: "gems", amount: 150, name: "150 Gems", icon: "ð", rarity: "epic" },
    { type: "ship", ship: "tank", name: "Shield Fortress", icon: "ð¡ï¸", rarity: "epic" },
    { type: "ship", ship: "striker", name: "Thunder Striker", icon: "âï¸", rarity: "epic" },
    { type: "ship", ship: "bomber", name: "Mega Bomber", icon: "ð£", rarity: "epic" },
    { type: "ship", ship: "viper", name: "Viper Elite", icon: "ð", rarity: "epic" },
  ],
  legendary: [
    { type: "credits", amount: 3000, name: "3000 Credits", icon: "ð¸", rarity: "legendary" },
    { type: "credits", amount: 5000, name: "5000 Credits", icon: "ð¸", rarity: "legendary" },
    { type: "gems", amount: 300, name: "300 Gems", icon: "ð", rarity: "legendary" },
    { type: "gems", amount: 500, name: "500 Gems", icon: "ð", rarity: "legendary" },
    { type: "ship", ship: "golden", name: "Golden Phoenix", icon: "ð¦", rarity: "legendary" },
    { type: "ship", ship: "dragon", name: "Dragon Fury", icon: "ð", rarity: "legendary" },
    { type: "ship", ship: "infinity", name: "Infinity Wing", icon: "â¾ï¸", rarity: "legendary" },
    { type: "ship", ship: "ultimate", name: "Ultimate Omega", icon: "ð¥", rarity: "legendary" },
  ],
  mythic: [
    { type: "credits", amount: 10000, name: "10,000 Credits", icon: "ð¸", rarity: "mythic" },
    { type: "credits", amount: 20000, name: "20,000 Credits", icon: "ð¸", rarity: "mythic" },
    { type: "gems", amount: 1000, name: "1000 Gems", icon: "ð", rarity: "mythic" },
    { type: "gems", amount: 2000, name: "2000 Gems", icon: "ð", rarity: "mythic" },
    { type: "ship", ship: "phoenix", name: "Phoenix Rising", icon: "ð¦", rarity: "mythic" },
    { type: "ship", ship: "dragon2", name: "Dragon Emperor", icon: "ð", rarity: "mythic" },
    { type: "ship", ship: "titan2", name: "Titan Omega", icon: "â¡", rarity: "mythic" },
    { type: "ship", ship: "champion", name: "Champion Hero", icon: "ð", rarity: "mythic" },
    { type: "ship", ship: "godly", name: "Godly Deity", icon: "â¡", rarity: "mythic" },
  ]
};

let currentReward = null;

function openBoxShop() {
  document.getElementById("box-panel").classList.add("active");
  document.getElementById("box-balance").textContent = playerMoney;
  document.getElementById("box-gems").textContent = playerGems;
  renderBoxes();
}

function closeBoxShop() {
  document.getElementById("box-panel").classList.remove("active");
}

function renderBoxes() {
  const grid = document.getElementById("boxes-grid");
  grid.innerHTML = "";

  Object.keys(BOXES).forEach(boxKey => {
    const box = BOXES[boxKey];
    const card = document.createElement("div");
    card.className = `box-card ${box.tier}`;
    card.innerHTML = `
      <div class="box-icon">${box.icon}</div>
      <div class="box-name">${box.name}</div>
      <div class="box-description">${box.description}</div>
      <div class="box-price">ð° ${box.price}</div>
      <button class="buy-box-btn" onclick="buyBox('${boxKey}')">BUY BOX</button>
    `;
    grid.appendChild(card);
  });
}

function buyBox(boxKey) {
  const box = BOXES[boxKey];

  if (playerMoney < box.price) {
    showError("NOT ENOUGH CREDITS!");
    return;
  }

  playerMoney -= box.price;
  savePlayerData();
  document.getElementById("box-balance").textContent = playerMoney;
  document.getElementById("box-gems").textContent = playerGems;
  updateMoneyDisplay();

  closeBoxShop();
  openBox(boxKey);
}

function openBox(boxKey) {
  const box = BOXES[boxKey];

  const animationEl = document.getElementById("opening-animation");
  const boxEl = document.getElementById("opening-box");

  boxEl.textContent = box.icon;
  animationEl.classList.add("active");

  setTimeout(() => {
    animationEl.classList.remove("active");

    const reward = rollReward(box.tier);
    currentReward = reward;
    showReward(reward);
  }, 2500);
}

function rollReward(boxTier) {
  let rarityPool = [];

  if (boxTier === "basic") {
    rarityPool = [
      { rarity: "common", weight: 70 },
      { rarity: "rare", weight: 25 },
      { rarity: "epic", weight: 5 }
    ];
  } else if (boxTier === "premium") {
    rarityPool = [
      { rarity: "common", weight: 20 },
      { rarity: "rare", weight: 50 },
      { rarity: "epic", weight: 25 },
      { rarity: "legendary", weight: 5 }
    ];
  } else if (boxTier === "legendary") {
    rarityPool = [
      { rarity: "rare", weight: 20 },
      { rarity: "epic", weight: 35 },
      { rarity: "legendary", weight: 40 },
      { rarity: "mythic", weight: 5 }
    ];
  } else if (boxTier === "mythic") {
    rarityPool = [
      { rarity: "legendary", weight: 30 },
      { rarity: "mythic", weight: 70 }
    ];
  }

  const totalWeight = rarityPool.reduce((sum, item) => sum + item.weight, 0);
  let random = Math.random() * totalWeight;

  let selectedRarity = "common";
  for (const item of rarityPool) {
    random -= item.weight;
    if (random <= 0) {
      selectedRarity = item.rarity;
      break;
    }
  }

  const rewardPool = BOX_REWARDS[selectedRarity];
  return rewardPool[Math.floor(Math.random() * rewardPool.length)];
}

function showReward(reward) {
  const revealEl = document.getElementById("reward-reveal");
  const cardEl = document.getElementById("reward-card-big");
  const rarityEl = document.getElementById("rarity-badge");
  const iconEl = document.getElementById("reward-icon-big");
  const nameEl = document.getElementById("reward-name-big");
  const descEl = document.getElementById("reward-description");

  cardEl.className = `reward-card-big ${reward.rarity}`;
  rarityEl.className = `rarity-badge ${reward.rarity}`;
  rarityEl.textContent = reward.rarity.toUpperCase();

  iconEl.textContent = reward.icon;
  nameEl.textContent = reward.name;

  if (reward.type === "credits") {
    descEl.textContent = `You received ${reward.amount} credits!`;
  } else if (reward.type === "gems") {
    descEl.textContent = `You received ${reward.amount} gems!`;
  } else if (reward.type === "ship") {
    if (ownedShips.includes(reward.ship)) {
      const refund = Math.floor(SHIPS[reward.ship].price * 0.5);
      reward.duplicate = true;
      reward.refundAmount = refund;
      descEl.textContent = `Duplicate! Refunded ${refund} credits.`;
    } else {
      descEl.textContent = `Unlocked: ${SHIPS[reward.ship].name}!`;
    }
  }

  revealEl.classList.add("active");
}

function claimReward() {
  if (!currentReward) return;

  if (currentReward.type === "credits") {
    playerMoney += currentReward.amount;
  } else if (currentReward.type === "gems") {
    playerGems += currentReward.amount;
  } else if (currentReward.type === "ship") {
    if (currentReward.duplicate) {
      playerMoney += currentReward.refundAmount;
    } else {
      ownedShips.push(currentReward.ship);
    }
  }

  savePlayerData();
  updateMoneyDisplay();

  document.getElementById("reward-reveal").classList.remove("active");
  currentReward = null;
}

function updateMoneyDisplay() {
  const moneyEl = document.getElementById("money-amount");
  if (moneyEl) moneyEl.textContent = playerMoney;
}


// LUCKY WHEEL (linked directly to playerMoney)
let wheelSpinning=false;
let wheelRotation=0;
let wheelPrize=null;
let wheelCanvas, wheelCtx;

const WHEEL_PRIZES=[
  {type:'credits',amount:100,icon:'ð°',color:'#FFD700',weight:25},
  {type:'credits',amount:500,icon:'ð°',color:'#FF9900',weight:20},
  {type:'credits',amount:1000,icon:'ðµ',color:'#00FF88',weight:15},
  {type:'gems',amount:5,icon:'ð',color:'#00CCFF',weight:10},
  {type:'gems',amount:10,icon:'ð',color:'#FF00FF',weight:8},
  {type:'ship',ship:'rapid',icon:'â¡',color:'#0099FF',weight:6},
  {type:'ship',ship:'shield',icon:'ð¡ï¸',color:'#00FF66',weight:5},
  {type:'ship',ship:'missile',icon:'ð',color:'#FF6600',weight:4},
  {type:'jackpot',amount:5000,icon:'ð°',color:'#FFD700',weight:3},
  {type:'ultra',ship:'ultra',icon:'ð',color:'#FF00FF',weight:1}
];

function openWheel(){
  const panel=document.getElementById('wheel-panel');
  if(!panel) return;
  panel.classList.add('active');
  if(!wheelCanvas){
    wheelCanvas=document.getElementById('wheel-canvas');
    if(wheelCanvas) wheelCtx=wheelCanvas.getContext('2d');
  }
  drawWheel();
  updateWheelUI();
}
function closeWheel(){
  const panel=document.getElementById('wheel-panel');
  if(panel) panel.classList.remove('active');
}
function updateWheelUI(){
  // DIRECTLY use the same playerMoney variable
  const money=playerMoney; 
  const moneyEl=document.getElementById('wheel-money');
  if(moneyEl) moneyEl.textContent=money;
  const spinBtn=document.getElementById('spin-btn');
  if(spinBtn){
    const canSpin=money>=999 && !wheelSpinning;
    spinBtn.disabled=!canSpin;
    spinBtn.textContent=canSpin?'ð° SPIN (999 CREDITS)':'â NEED 999 CREDITS';
  }
}
function drawWheel(){
  if(!wheelCtx) return;
  const cx=200,cy=200,r=180;
  wheelCtx.clearRect(0,0,400,400);
  wheelCtx.save();
  wheelCtx.translate(cx,cy);
  wheelCtx.rotate(wheelRotation*Math.PI/180);
  wheelCtx.translate(-cx,-cy);
  const seg=360/WHEEL_PRIZES.length;
  WHEEL_PRIZES.forEach((p,i)=>{
    const start=(i*seg-90)*Math.PI/180;
    const end=((i+1)*seg-90)*Math.PI/180;
    wheelCtx.beginPath();
    wheelCtx.moveTo(cx,cy);
    wheelCtx.arc(cx,cy,r,start,end);
    wheelCtx.closePath();
    wheelCtx.fillStyle=p.color;
    wheelCtx.fill();
    wheelCtx.strokeStyle='#000';
    wheelCtx.lineWidth=3;
    wheelCtx.stroke();
    const ang=start+(seg/2)*Math.PI/180;
    const tx=cx+Math.cos(ang)*120;
    const ty=cy+Math.sin(ang)*120;
    wheelCtx.save();
    wheelCtx.translate(tx,ty);
    wheelCtx.rotate(ang+Math.PI/2);
    wheelCtx.font='bold 28px Arial';
    wheelCtx.textAlign='center';
    wheelCtx.fillStyle='#FFF';
    wheelCtx.strokeStyle='#000';
    wheelCtx.lineWidth=3;
    wheelCtx.strokeText(p.icon,0,0);
    wheelCtx.fillText(p.icon,0,0);
    wheelCtx.restore();
  });
  wheelCtx.restore();
}
function spinWheel(){
  if(wheelSpinning) return;
  const money=playerMoney;
  if(money<999){
    if(typeof showError==='function') showError('NOT ENOUGH CREDITS! NEED 999');
    updateWheelUI();
    return;
  }
  // Deduct directly from playerMoney
  playerMoney-=999;
  if(typeof updateMoneyDisplay==='function') updateMoneyDisplay();
  if(typeof savePlayerData==='function') savePlayerData();
  updateWheelUI();
  const total=WHEEL_PRIZES.reduce((s,p)=>s+p.weight,0);
  let rand=Math.random()*total; let index=0;
  for(let i=0;i<WHEEL_PRIZES.length;i++){
    rand-=WHEEL_PRIZES[i].weight;
    if(rand<=0){index=i;break;}
  }
  wheelPrize=WHEEL_PRIZES[index];
  const seg=360/WHEEL_PRIZES.length;
  const target=index*seg;
  const spins=5*360;
  const finalRot=spins+(360-target)+seg/2;
  const startRot=wheelRotation%360;
  const startTime=Date.now();
  const dur=4000;
  wheelSpinning=true;
  function anim(){
    const t=Date.now()-startTime;
    const prog=Math.min(t/dur,1);
    const ease=1-Math.pow(1-prog,3);
    wheelRotation=startRot+finalRot*ease;
    drawWheel();
    if(prog<1){requestAnimationFrame(anim);}else{wheelSpinning=false;showWheelResult();updateWheelUI();}
  }
  anim();
}
function showWheelResult(){
  const popup=document.getElementById('wheel-result');
  if(!popup) return;
  const iconEl=document.getElementById('wheel-result-icon');
  const textEl=document.getElementById('wheel-result-text');
  if(iconEl) iconEl.textContent=wheelPrize.icon;
  let txt='';
  if(wheelPrize.type==='credits' || wheelPrize.type==='jackpot') txt=wheelPrize.amount+' CREDITS';
  else if(wheelPrize.type==='gems') txt=wheelPrize.amount+' GEMS';
  else if(wheelPrize.type==='ship' || wheelPrize.type==='ultra') txt='NEW SHIP!';
  if(textEl) textEl.textContent=txt;
  popup.classList.add('active');
}
function claimWheelPrize(){
  if(!wheelPrize){
    const popup=document.getElementById('wheel-result');
    if(popup) popup.classList.remove('active');
    return;
  }
  if(wheelPrize.type==='credits' || wheelPrize.type==='jackpot'){
    playerMoney+=wheelPrize.amount;
    if(typeof updateMoneyDisplay==='function') updateMoneyDisplay();
  }else if(wheelPrize.type==='gems'){
    playerGems+=wheelPrize.amount;
    if(typeof updateGemDisplay==='function') updateGemDisplay();
  }else if(wheelPrize.type==='ship' || wheelPrize.type==='ultra'){
    if(typeof ownedShips!=='undefined'){
      const id=wheelPrize.ship;
      if(!ownedShips.includes(id)) ownedShips.push(id); else if(typeof addMoney==='function') addMoney(1000);
      if(typeof savePlayerData==='function') savePlayerData();
    }
  }
  if(typeof savePlayerData==='function') savePlayerData();
  const popup=document.getElementById('wheel-result');
  if(popup) popup.classList.remove('active');
  wheelPrize=null;
}

setInterval(()=>{const panel=document.getElementById('wheel-panel');if(panel&&panel.classList.contains('active'))updateWheelUI();},500);
</script>


<div class="error-toast" id="error-toast">
  <h2 class="error-text">â ï¸ UH-OH!<br>NOT ENOUGH CREDITS! â ï¸</h2>
</div>

<div class="shop-panel" id="shop-panel">
  <div class="shop-content">
    <div class="shop-header">
      <h2 class="shop-title">ð¸ SHIP SHOP</h2>
      <div class="shop-balance">ð° <span id="shop-money">0</span> CREDITS</div>
    </div>
    <div class="ships-grid" id="ships-grid"></div>
    <button class="shop-close-btn" onclick="closeShop()">CLOSE SHOP</button>
  </div>
</div>

<div class="pass-panel" id="pass-panel">
  <div class="pass-content">
    <div class="pass-header">
      <h2 class="pass-title">ð¸ SEASON 1 SHIP PASS</h2>
      <div class="pass-progress">
        <div class="pass-level">LEVEL <span id="pass-level">1</span> / 10</div>
        <div class="pass-xp"><span id="pass-xp">0</span> / <span id="pass-xp-needed">100</span> XP</div>
      </div>
      <div class="pass-bar-bg">
        <div class="pass-bar-fill" id="pass-bar"></div>
      </div>
    </div>
    <div class="quests-section">
      <h3 class="section-title">ð DAILY QUESTS</h3>
      <div class="quests-grid" id="quests-grid"></div>
    </div>
    <div class="rewards-section">
      <h3 class="section-title">ð SEASON REWARDS</h3>
      <div class="rewards-grid" id="rewards-grid"></div>
    </div>
    <button class="shop-close-btn" onclick="closeShipPass()">CLOSE</button>
  </div>
</div>

<div class="admin-panel" id="admin-panel">
  <div class="admin-content">
    <h2 class="admin-title">â  ADMIN PANEL</h2>
    <input type="number" class="admin-input" id="admin-money-input" placeholder="Enter credits amount" />
    <div class="admin-buttons">
      <button class="admin-action-btn" onclick="adminAddMoney()">ADD CREDITS</button>
      <button class="admin-action-btn cancel" onclick="closeAdminPanel()">CANCEL</button>
    </div>
  </div>
</div>

<div class="box-panel" id="box-panel">
  <div class="box-content">
    <div class="box-header">
      <div class="box-title">ð LOOT BOX SHOP</div>
      <div class="currency-container">
        <div class="box-balance">ð° <span id="box-balance">0</span> Credits</div>
        <div class="gem-display"><span class="gem-icon">ð</span><span id="box-gems">0</span> Gems</div>
      </div>
    </div>

    <div class="boxes-grid" id="boxes-grid"></div>

    <button class="shop-close-btn" onclick="closeBoxShop()">â CLOSE</button>
  </div>
</div>

<div class="opening-animation" id="opening-animation">
  <div class="opening-box" id="opening-box">ð¦</div>
  <div class="opening-text">OPENING...</div>
</div>

<div class="reward-reveal" id="reward-reveal">
  <div class="reward-card-big" id="reward-card-big">
    <div class="rarity-badge" id="rarity-badge">COMMON</div>
    <div class="reward-icon-big" id="reward-icon-big">ð</div>
    <div class="reward-name-big" id="reward-name-big">Reward Name</div>
    <div class="reward-description" id="reward-description">You got something awesome!</div>
    <button class="claim-reward-btn" onclick="claimReward()">CLAIM REWARD</button>
  </div>
</div>

<div class="quest-complete-toast" id="quest-toast">
  <h2 class="quest-text">ð¯ QUEST COMPLETE!<br><span id="quest-reward-text">+50 XP</span></h2>
</div>

<div class="levelup-toast" id="levelup-toast">
  <h2 class="levelup-text">â¬ï¸ LEVEL UP!<br>SHIP PASS LEVEL <span id="levelup-num">2</span>!</h2>
</div>



<div class="wheel-panel" id="wheel-panel">
  <div class="wheel-content">
    <h2 class="wheel-title">ð¡ LUCKY WHEEL ð¡</h2>
    <p class="wheel-sub">ð° 999 CREDITS PER SPIN ð°</p>
    <p class="wheel-balance">YOU HAVE: <span id="wheel-money">0</span> ð°</p>

    <div class="wheel-container">
      <div class="wheel-pointer">â¼</div>
      <canvas id="wheel-canvas" width="400" height="400"></canvas>
      <div class="wheel-center">SPIN</div>
    </div>

    <button class="spin-btn" id="spin-btn" onclick="spinWheel()">ð° SPIN (999 CREDITS)</button>
    <button class="wheel-close" onclick="closeWheel()">CLOSE</button>
  </div>
</div>

<div class="wheel-result" id="wheel-result">
  <div class="wheel-result-card">
    <div class="wheel-result-title">YOU WON!</div>
    <div class="wheel-result-icon" id="wheel-result-icon">ð°</div>
    <div class="wheel-result-text" id="wheel-result-text">100 CREDITS</div>
    <button class="wheel-claim" onclick="claimWheelPrize()">CLAIM</button>
  </div>
</div>
</body>
</html>
